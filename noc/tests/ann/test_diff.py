import textwrap

import pytest

from checkist.ann.diff import DiffStats


class TestDiffStats:
    @pytest.mark.parametrize("text, expected", (
        (
            {
                "/etc/network/interfaces": textwrap.dedent("""\
                    --- /etc/network/interfaces
                    +++ /etc/network/interfaces
                    @@ -9,25 +9,25 @@
                    iface eth0
                        address 172.24.92.177/21
                        gateway 172.24.95.254
                    +    mtu 1500
                        vrf mgmt
                    -    mtu 1500

                    auto mgmt
                    iface mgmt
                    -    vrf-table auto
                        address 127.0.0.1/8
                        address ::1/128
                    +    vrf-table auto
                    +"""),
                "/etc/resolv.conf": textwrap.dedent("""\
                    --- /etc/resolv.conf
                    +++ /etc/resolv.conf
                    @@ -0,0 +1,4 @@
                    +domain yndx.net
                    +search yndx.net yandex.net yandex.ru yandex-team.ru
                    +nameserver 127.0.0.1
                    +options timeout:1 attempts:1"""),
                "/etc/telegraf/telegraf.d/annushka.conf": textwrap.dedent("""\
                    --- /etc/telegraf/telegraf.d/annushka.conf
                    +++ /etc/telegraf/telegraf.d/annushka.conf
                    @@ -0,0 +1,35 @@
                    +# generated by annushka
                    +
                    +
                    +[[inputs.ethtool]]
                    +interface_exclude = ["dummy*", "vlan*"]"""),
            },
            DiffStats(added=12, removed=2),
        ),
        (
            textwrap.dedent("""\
                - vlan batch 1503
                - vlan batch 333 542 595 604 688 700 761 to 763 788 999 1478
                + vlan batch 333 542 595 604 688 700 761 to 763 788 999 1478 1503"""),
            DiffStats(added=1, removed=2),
        ),
    ))
    def test_from_text(self, text, expected):
        assert DiffStats.from_text(text) == expected

    def test_sum(self):
        assert DiffStats.sum((
            DiffStats(added=1, removed=2),
            DiffStats(added=0, removed=2),
            DiffStats(added=3, removed=4),
        )) == DiffStats(added=4, removed=8)
