{
  "dst": {
    "features": [
      {
        "can_be_found_without_question": true,
        "entity": "order_id",
        "entity_extract_order": 0,
        "is_array": false,
        "key": "order_id",
        "type": "int"
      },
      {
        "can_be_found_without_question": true,
        "entity": "order_id",
        "is_array": true,
        "key": "order_ids",
        "type": "int"
      },
      {
        "can_be_found_without_question": true,
        "is_array": false,
        "key": "sure_topic",
        "type": "str"
      }
    ]
  },
  "flags": {
    "predicate_in_processes": true
  },
  "nlg": {
    "enrich": [
      {
        "add_at": "begin",
        "if_feature": "do_greeting",
        "template": "greeting"
      },
      {
        "add_at": "begin",
        "if_feature": "do_greeting_with_name",
        "template": "greeting_with_name"
      }
    ],
    "localisations": {
      "greeting": {
        "en": "Good afternoon!",
        "ru": "Здравствуйте!",
        "uk": "Добрий день!"
      },
      "greeting_with_name": {
        "en": "Good afternoon! {user_first_name}",
        "ru": "Здравствуйте! {user_first_name}",
        "uk": "Добрий день! {user_first_name}"
      }
    }
  },
  "nlu": {
    "entities": [
      {
        "extractor": {
          "name": "regular_expression",
          "params": {
            "regular_expression": "\\d{7}"
          }
        },
        "name": "order_id",
        "type": "int"
      }
    ],
    "model": {
      "model_slug": "test_model",
      "model_title": "Модель",
      "model_topics": [
        {
          "slug": "order_status",
          "threshold_based_on_precision": 0.5
        },
        {
          "slug": "cancel_order",
          "threshold_based_on_precision": 0.5
        },
        {
          "slug": "bonuses",
          "threshold_based_on_precision": 0.5
        },
        {
          "slug": "other__classes",
          "threshold_based_on_precision": 0.5
        },
        {
          "slug": "general_thanks",
          "threshold_based_on_precision": 0.5
        }
      ],
      "model_version": "1"
    },
    "topics": [
      {
        "parent_slug": null,
        "rule_value": "model_sure_topic is \"order_status\"",
        "slug": "order_status"
      },
      {
        "parent_slug": null,
        "rule_value": "model_sure_topic is \"cancel_order\"",
        "slug": "cancel_order"
      },
      {
        "parent_slug": null,
        "rule_value": "model_sure_topic is \"bonuses\"",
        "slug": "bonuses"
      },
      {
        "parent_slug": null,
        "rule_value": "false",
        "slug": "other__classes"
      },
      {
        "parent_slug": null,
        "rule_value": "model_sure_topic is \"general_thanks\"",
        "slug": "general_thanks"
      }
    ]
  },
  "policy": {
    "main_group": {
      "policy_blocks": [
        {
          "policy_items": [
            {
              "actions": [
                {
                  "parameters": {
                    "features": [
                      {
                        "key": "order_id",
                        "status": "in_progress",
                        "value": null
                      }
                    ]
                  },
                  "type": "change_state"
                }
              ],
              "max_retries": 2,
              "predicate": "(order_id is undefined or order_id is null)",
              "response_action": {
                "parameters": {
                  "text": "Подскажите номер вашего заказа?"
                },
                "type": "response"
              },
              "slug": "pi1",
              "tags": [
                "1"
              ],
              "topic_slug": "order_status"
            },
            {
              "predicate": "and order_id is not undefined and order_id is not null",
              "response_action": {
                "parameters": {
                  "close": true,
                  "forward_line": null,
                  "text": "Ваш заказ находится в статусе {order_status}"
                },
                "type": "response"
              },
              "slug": "pi2",
              "tags": [
                "2"
              ],
              "topic_slug": "order_status"
            }
          ],
          "slug": "pb1"
        },
        {
          "policy_items": [
            {
              "predicate": "order_id is undefined",
              "response_action": {
                "parameters": {
                  "text": "Подскажите номер вашего заказа?"
                },
                "type": "response"
              },
              "slug": "pi3",
              "topic_slug": "cancel_order"
            },
            {
              "predicate": "order_id is not undefined and order_id is not null",
              "response_action": {
                "parameters": {
                  "close": true,
                  "forward_line": null,
                  "text": "Ваш заказ {order_id} будет отменен"
                },
                "type": "response"
              },
              "slug": "pi4",
              "topic_slug": "cancel_order"
            }
          ]
        },
        {
          "policy_items": [
            {
              "predicate": "true",
              "response_action": {
                "parameters": {
                  "close": true,
                  "forward_line": null,
                  "text": "Бонусы начисляются 10% от покупки"
                },
                "type": "response"
              },
              "slug": "pi5",
              "topic_slug": "bonuses"
            }
          ]
        },
        {
          "policy_items": [
            {
              "max_retries": 2,
              "predicate": "true",
              "response_action": {
                "parameters": {
                  "forward_line": null,
                  "text": "Всегда пожалуйста"
                },
                "type": "response"
              },
              "slug": "pi5",
              "topic_slug": "general_thanks"
            }
          ]
        }
      ]
    },
    "pre_group": {
      "policy_blocks": [
        {
          "policy_items": [
            {
              "actions": [
                {
                  "parameters": {
                    "features": [
                      {
                        "key": "do_greeting_with_name",
                        "status": "defined",
                        "value": false
                      },
                      {
                        "key": "do_greeting",
                        "status": "defined",
                        "value": true
                      }
                    ]
                  },
                  "type": "change_state"
                }
              ],
              "predicate": "iteration_number is not undefined and iteration_number == 1 and do_greeting is undefined and do_greeting_with_name is undefined",
              "response_action": null,
              "slug": "dg1",
              "topic_slug": null
            }
          ]
        },
        {
          "policy_items": [
            {
              "actions": [
                {
                  "parameters": {
                    "features": [
                      {
                        "key": "do_greeting_with_name",
                        "status": "defined",
                        "value": true
                      },
                      {
                        "key": "do_greeting",
                        "status": "defined",
                        "value": false
                      }
                    ]
                  },
                  "type": "change_state"
                }
              ],
              "predicate": "iteration_number is not undefined and iteration_number == 1 and user_first_name is not undefined and do_greeting is undefined and do_greeting_with_name is undefined",
              "response_action": null,
              "slug": "dg2",
              "topic_slug": null
            }
          ]
        },
        {
          "policy_items": [
            {
              "actions": [
                {
                  "parameters": {
                    "features": [
                      {
                        "key": "do_greeting_with_name",
                        "status": "defined",
                        "value": false
                      },
                      {
                        "key": "do_greeting",
                        "status": "defined",
                        "value": false
                      }
                    ]
                  },
                  "type": "change_state"
                }
              ],
              "predicate": "iteration_number is not undefined and iteration_number > 1 and ( do_greeting is true or do_greeting_with_name is true )",
              "response_action": null,
              "slug": "dg3",
              "topic_slug": null
            }
          ]
        }
      ]
    }
  }
}
