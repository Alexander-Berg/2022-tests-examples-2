FUNC(getAvailableCashback,ARGS(),B(IF(U(?,B(B(fix,.,F(category_data)),.,F(yaplus_coeff))),CR(enabled=true,price_decreasing_coeff=U(*,B(B(fix,.,F(category_data)),.,F(yaplus_coeff))),rate=B(1.000000,-,U(*,B(B(fix,.,F(category_data)),.,F(yaplus_coeff))))));CR(enabled=false,price_decreasing_coeff=1.000000,rate=0.000000)));FUNC(calcCashback,ARGS((base,double),(rate,double)),B(FG(UserMeta,IF(B("cashback_fixed_price",in,B(B(ride,.,F(ride)),.,F(user_meta))),CR(metadata=MAP("user_meta_debug:used_meta"=B(B(B(ride,.,F(ride)),.,F(user_meta)),.,"cashback_fixed_price")),value=B(B(B(ride,.,F(ride)),.,F(user_meta)),.,"cashback_fixed_price")));CR(metadata=MAP("user_meta_debug:empty_meta"=1.000000),value=B(FA(base,double),*,FA(rate,double))));CR(metadata=MAP("user_meta_debug:no_meta"=1.000000),value=B(FA(base,double),*,FA(rate,double)))));SV(using_user_meta_enabled,B("using_user_meta_enabled",in,B(fix,.,F(exps))));IF(U(!,VA(using_user_meta_enabled)),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(unite_total_price_enabled,B("cashback_unite_total_price",in,B(fix,.,F(exps))));IF(VA(unite_total_price_enabled),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));E("prod_yaplus_cashback_usermeta_driver",1.000000);IF(U(?,B(fix,.,F(payment_type))),SV(corp_type,B(U(*,B(fix,.,F(payment_type))),==,"corp"));SV(wallet_type,B(U(*,B(fix,.,F(payment_type))),==,"personal_wallet"));SV(corp_acc_type,B(U(*,B(fix,.,F(payment_type))),==,"coop_account"));SV(bad_type,B(B(VA(corp_type),||,VA(wallet_type)),||,VA(corp_acc_type)));IF(U(!,B(B(fix,.,F(user_data)),.,F(has_yaplus))),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(VA(bad_type),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(cashback_params,FC(getAvailableCashback,NT(),R(enabled=bool,metadata=std::unordered_map<std::string,double>,price_decreasing_coeff=double,rate=double)));IF(B(VA(cashback_params),.,F(enabled)),IF(U(!,B(B(fix,.,F(user_data)),.,F(has_cashback_plus))),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(B(U(*,B(fix,.,F(payment_type))),==,"cash"),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(U(?,B(fix,.,F(complements))),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(B(B(VA(cashback_params),.,F(price_decreasing_coeff)),<,0.010000),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(B(B(VA(cashback_params),.,F(rate)),<,0.010000),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(cashback_for_plus_available,B("cashback_for_plus_availability",in,B(fix,.,F(exps))));IF(U(!,VA(cashback_for_plus_available)),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(cashback_rate,B(VA(cashback_params),.,F(rate)));SV(price_decreasing_coeff,B(VA(cashback_params),.,F(price_decreasing_coeff)));SV(rounded_total_price,B(U(*,B(ride,.,F(price))),round_to,B(fix,.,F(rounding_factor))));SV(calc_res,FC(calcCashback,NT(base=VA(rounded_total_price),rate=VA(cashback_rate)),R(metadata=std::unordered_map<std::string,double>,value=double)));SV(cashback_price,B(VA(calc_res),.,F(value)));SV(rounded_cashback_price,B(VA(cashback_price),round_to,B(fix,.,F(rounding_factor))));SV(rounded_new_ride_price,B(VA(rounded_total_price),-,VA(rounded_cashback_price)));SV(new_price_decreasing_coeff,T(B(U(*,B(ride,.,F(price))),>=,1.000000),B(VA(rounded_new_ride_price),/,U(*,B(ride,.,F(price)))),VA(price_decreasing_coeff)));SV(meta,B(VA(calc_res),.,F(metadata)));CR(boarding=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(boarding)),destination_waiting=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(destination_waiting)),distance=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(distance)),metadata=VA(meta),requirements=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(requirements)),time=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(time)),transit_waiting=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(transit_waiting)),waiting=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(waiting)))));CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting)))
