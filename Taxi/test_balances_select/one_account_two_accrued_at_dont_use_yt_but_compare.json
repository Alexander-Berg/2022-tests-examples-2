{
  "compare_yt_to_pg": true,
  "expected_accounts_request": {
    "accounts": [
      {
        "agreement_id": "taxi/yandex_ride",
        "entity_external_id": "taximeter_driver_id/a3608/c6bda"
      }
    ]
  },
  "expected_balances_request": {
    "accounts": [
      {
        "agreement_id": "taxi/yandex_ride",
        "entity_external_id": "taximeter_driver_id/a3608/c6bda"
      }
    ],
    "accrued_at": [
      "2018-10-03T23:59:00.000000+00:00",
      "2018-10-02T12:00:00.000000+00:00"
    ]
  },
  "expected_requested_resources": [
    [
      "/v1/balances/select:pg:balances",
      1
    ]
  ],
  "expected_response": {
    "entries": [
      {
        "account": {
          "account_id": 31370003,
          "agreement_id": "taxi/yandex_ride",
          "currency": "RUB",
          "entity_external_id": "taximeter_driver_id/a3608/c6bda",
          "sub_account": "income"
        },
        "balances": [
          {
            "accrued_at": "2018-10-03T23:59:00.000000+00:00",
            "balance": "1000.0000",
            "last_created": "2018-10-03T11:00:00.000000+00:00",
            "last_entry_id": 839000
          },
          {
            "accrued_at": "2018-10-02T12:00:00.000000+00:00",
            "balance": "10.0000",
            "last_created": "2018-10-02T11:00:00.000000+00:00",
            "last_entry_id": 739000
          }
        ]
      }
    ]
  },
  "expected_spent_resources": [
    [
      "/v1/balances/select:yt:balances",
      1
    ],
    [
      "/v1/balances/select:pg:balances",
      2
    ]
  ],
  "expected_yql_params": [
    [
      "//home/taxi/unstable/replica/api/billing_accounts/balance_at",
      [
        31370003
      ],
      1538481600000000
    ],
    [
      "//home/taxi/unstable/replica/api/billing_accounts/balance_at",
      31370003,
      [
        1538478000000000
      ]
    ]
  ],
  "expected_yql_queries": [
    [
      "      *",
      " FROM %t AS balance_at",
      "WHERE false",
      "OR (balance_at.account_id = %p AND balance_at.accrued_at IN %p)"
    ],
    [
      "MAX(accrued_at) AS accrued, account_id AS acc_id",
      "FROM %t",
      "WHERE account_id IN %p AND accrued_at <= %p",
      "GROUP BY account_id"
    ]
  ],
  "pg_accounts": {
    "accounts": [
      {
        "account_id": 31370003,
        "agreement_id": "taxi/yandex_ride",
        "currency": "RUB",
        "entity_external_id": "taximeter_driver_id/a3608/c6bda",
        "expired": "2018-01-01T00:00:00.000000+00:00",
        "opened": "2018-01-01T00:00:00.000000+00:00",
        "sub_account": "income"
      }
    ]
  },
  "pg_balances": [
    {
      "account": {
        "account_id": 31370003,
        "agreement_id": "taxi/yandex_ride",
        "currency": "RUB",
        "entity_external_id": "taximeter_driver_id/a3608/c6bda",
        "sub_account": "income"
      },
      "balances": [
        {
          "accrued_at": "2018-10-03T23:59:00.000000+00:00",
          "balance": "1000.0000",
          "last_created": "2018-10-03T11:00:00.000000+00:00",
          "last_entry_id": 839000
        },
        {
          "accrued_at": "2018-10-02T12:00:00.000000+00:00",
          "balance": "10.0000",
          "last_created": "2018-10-02T11:00:00.000000+00:00",
          "last_entry_id": 739000
        }
      ]
    }
  ],
  "request_body": {
    "accounts": [
      {
        "agreement_id": "taxi/yandex_ride",
        "entity_external_id": "taximeter_driver_id/a3608/c6bda"
      }
    ],
    "accrued_at": [
      "2018-10-03T23:59:00+00:00",
      "2018-10-02T12:00:00+00:00"
    ]
  },
  "use_yt": false,
  "yt_data": [
    {
      "items": [
        {
          "acc_id": 31370003,
          "accrued": 1538478000000000
        }
      ]
    },
    {
      "items": [
        {
          "balance_at.account_id": 31370003,
          "balance_at.accrued_at": 1538478000000000,
          "balance_at.balance": "10.0000",
          "balance_at.journal_id": 739000
        }
      ]
    }
  ]
}
