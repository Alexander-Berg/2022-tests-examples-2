{
  "doc": {
    "data": {
      "alias_id": "some_alias_id",
      "billing_contract": {
        "acquiring_percent": "0",
        "currency": "RUB",
        "currency_rate": "1",
        "donate_multiplier": "1",
        "ind_bel_nds_percent": null,
        "offer_currency": "RUB",
        "offer_currency_rate": "1",
        "rebate_percent": "0",
        "subventions_hold_delay": 99999
      },
      "billing_contract_is_set": true,
      "order_id": "some_order_id",
      "performer": {
        "db_id": "e414001e44434a00a93b65cc49548d5e",
        "driver_uuid": "7bc343fc873a49159483e487663ba761"
      },
      "subvention": {
        "amount": "223.5",
        "amount_by_reason": {
          "dryclean": "100",
          "test_reason_1": "123.5"
        },
        "currency": "RUB"
      },
      "version": 2
    },
    "doc_id": 1000,
    "event_at": "2018-11-16T13:00:00+00:00",
    "external_event_ref": "taxi/manual_subvention/some_alias_id/2",
    "external_obj_id": "taxi/manual_subvention/some_alias_id",
    "kind": "manual_subvention",
    "revision": 1,
    "service": "billing-orders",
    "status": "new"
  },
  "existing_docs": [
    {
      "data": {
        "version": 1
      },
      "doc_id": 111,
      "event_at": "2018-11-15T12:00:00+00:00",
      "external_event_ref": "taxi/manual_subvention/some_alias_id/1/subvention_handled",
      "external_obj_id": "taxi/manual_subvention/some_alias_id/journal",
      "journal_entries": [
        {
          "account": {
            "account_id": 0
          },
          "amount": "100",
          "details": {
            "amount_by_reason": {
              "dryclean": "100 RUB"
            }
          },
          "entry_id": 0,
          "event_at": "2018-11-15T12:00:00.000000+00:00"
        },
        {
          "account": {
            "account_id": 1
          },
          "amount": "100",
          "details": {
            "amount_by_reason": {
              "dryclean": "100 RUB"
            }
          },
          "entry_id": 1,
          "event_at": "2018-11-15T12:00:00.000000+00:00"
        }
      ],
      "kind": "subvention_journal",
      "service": "billing-subventions",
      "status": "new"
    },
    {
      "data": {
        "context": {
          "antifraud_config": {
            "min_travel_distance": 0,
            "min_travel_time": 0
          },
          "based_on_doc_id": 1000,
          "driver_promocode_config": {
            "enabled": true,
            "min_commission": "1 RUB"
          },
          "hold_config": {
            "delay": 0
          }
        },
        "order": {
          "accepted_by_driver_at": "2018-07-02T00:30:00.750000+00:00",
          "alias_id": "some_alias_id",
          "billing_at": "2018-07-02T00:30:00.750000+00:00",
          "closed_without_accept": false,
          "completed_at": "2018-07-02T00:40:00.750000+00:00",
          "completed_by_dispatcher": false,
          "cost": "2 RUB",
          "cost_details": {
            "call_center_commission": "0.0000 RUB",
            "corp_vat_for_commission": "0 RUB",
            "corp_vat_for_subvention": "0 RUB",
            "cost_for_commission": "2 RUB",
            "cost_for_subvention": "2 RUB",
            "discount_details": {
              "amendments": [],
              "discount": "5 RUB"
            }
          },
          "discount": {
            "driver_less_coeff": "1",
            "initial_cost": "0 RUB",
            "method": "time-dist",
            "rate": "0"
          },
          "driver_promocode_ids": [],
          "driver_workshift_ids": [],
          "due": "2018-07-02T00:00:00.750000+00:00",
          "id": "some_order_id",
          "park": {
            "brandings": []
          },
          "park_corp_vat": null,
          "park_ride_sum": "0 RUB",
          "payment_type": "cash",
          "performer": {
            "activity_points": 0,
            "db_id": "db_id",
            "driver_license": "AXH903VV",
            "driver_license_personal_id": "8hd93jdlakhf84030ejd9390z",
            "has_co_branding": true,
            "has_lightbox": false,
            "has_sticker": false,
            "park_id": "clid",
            "tags": [
              "some_tag"
            ],
            "unique_driver_id": "0123456789ab0123456789ab",
            "uuid": "uuid",
            "zone": "driver_zone"
          },
          "rebate_rate": "0",
          "source": "call_center",
          "status": "finished",
          "subvention_geoareas": [
            "moscow"
          ],
          "surge_rate": "1.0",
          "tariff": {
            "class_": "econom",
            "minimal_cost": "0 RUB",
            "modified_minimal_cost": "0 RUB"
          },
          "taxi_status": "complete",
          "toll_road_payment_price": null,
          "travel_distance": 123.0,
          "travel_time": 60.0,
          "tzinfo": "Europe/Moscow",
          "updated": "2018-07-02T00:40:00.750000+00:00",
          "zone_name": "moscow"
        }
      },
      "doc_id": 12345678,
      "event_at": "2018-07-02T00:40:00.750000+00:00",
      "external_event_ref": "order_ready_for_billing",
      "external_obj_id": "alias_id/some_alias_id",
      "journal_entries": [],
      "kind": "order_ready_for_billing",
      "service": "taxi-billing-subventions",
      "status": "new"
    }
  ],
  "expected_accounts": [
    {
      "account_id": 0,
      "agreement_id": "dry/migration/taxi/driver_balance",
      "currency": "RUB",
      "entity_external_id": "taximeter_driver_id/e414001e44434a00a93b65cc49548d5e/7bc343fc873a49159483e487663ba761",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "sub_account": "dry/migration/subvention"
    },
    {
      "account_id": 1,
      "agreement_id": "subvention_agreement/misc",
      "currency": "RUB",
      "entity_external_id": "taximeter_driver_id/e414001e44434a00a93b65cc49548d5e/7bc343fc873a49159483e487663ba761",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "sub_account": "income"
    }
  ],
  "expected_created_docs": [
    {
      "data": {
        "reverse_doc_id": 111
      },
      "event_at": "2018-11-16T13:00:00.000000+00:00",
      "external_event_ref": "taxi/manual_subvention/some_alias_id/journal/1/reversal",
      "external_obj_id": "doc_reversal/taxi/manual_subvention/some_alias_id/journal",
      "journal_entries": [
        {
          "account_id": 0,
          "amount": "-100",
          "details": {
            "amount_by_reason": {
              "dryclean": "100 RUB"
            },
            "reverse_entry_id": 0
          },
          "event_at": "2018-11-16T13:00:00.000000+00:00"
        },
        {
          "account_id": 1,
          "amount": "-100",
          "details": {
            "amount_by_reason": {
              "dryclean": "100 RUB"
            },
            "reverse_entry_id": 1
          },
          "event_at": "2018-11-16T13:00:00.000000+00:00"
        }
      ],
      "kind": "journal_reversal",
      "service": "billing-subventions",
      "status": "new",
      "tags": [
        "system://parent_doc_id/1000",
        "taxi/alias_id/some_alias_id"
      ]
    },
    {
      "data": {
        "accepted_by_driver_at": "2018-07-02T00:30:00.750000+00:00",
        "activity_points": 0,
        "base_doc_id": 1000,
        "billing_client_id": "billing_client_id",
        "billing_v2_id": null,
        "closed_without_accept": false,
        "comment": null,
        "completed_by_dispatcher": false,
        "create_via_py2": false,
        "currency_data": null,
        "db_id": "db_id",
        "discount_details": {
          "amendments": [],
          "discount": "0 RUB"
        },
        "driver_license": "AXH903VV",
        "dry_mode": true,
        "due": "2018-07-02T00:00:00.750000+00:00",
        "force_hold": false,
        "has_co_branding": true,
        "has_lightbox": false,
        "has_sticker": false,
        "hold_config": {
          "delay": 0
        },
        "is_cargo": false,
        "order_alias_id": "some_alias_id",
        "order_completed_at": "2018-07-02T00:40:00.750000+00:00",
        "order_id": "some_order_id",
        "order_payment_type": "cash",
        "park": null,
        "park_id": "clid",
        "rule_details": [
          {
            "extra": {
              "dryclean": "100",
              "test_reason_1": "123.5"
            },
            "is_once": true,
            "limit_ref": null,
            "payment_type": "bonus",
            "rule_id": {
              "group_id": "",
              "id": "subvention_bonus"
            },
            "rule_type": "misc",
            "subvention_geoareas": [],
            "value": "223.5000 RUB"
          }
        ],
        "rule_group": "manual",
        "sub_commission": "0 RUB",
        "subvention_geoareas": [
          "moscow"
        ],
        "tags": [
          "some_tag"
        ],
        "tariff_class": "econom",
        "unique_driver_id": "0123456789ab0123456789ab",
        "unrealized_sub_commission": "0 RUB",
        "uuid": "uuid",
        "value": "223.5000 RUB",
        "zone_name": "moscow"
      },
      "event_at": "2018-11-30T19:31:35.000000+00:00",
      "external_event_ref": "manual_subvention/1000/subventions_input_enrichment_needed",
      "external_obj_id": "alias_id/some_alias_id",
      "journal_entries": [],
      "kind": "subventions_input_enrichment_needed",
      "service": "billing-subventions",
      "status": "new"
    },
    {
      "data": {
        "version": 2
      },
      "event_at": "2018-11-30T19:31:35.000000+00:00",
      "external_event_ref": "taxi/manual_subvention/some_alias_id/2/subvention_handled",
      "external_obj_id": "taxi/manual_subvention/some_alias_id/journal",
      "journal_entries": [
        {
          "account_id": 0,
          "amount": "223.5",
          "details": {
            "amount_by_reason": {
              "dryclean": "100 RUB",
              "test_reason_1": "123.5 RUB"
            }
          },
          "event_at": "2018-11-30T19:31:35.000000+00:00"
        },
        {
          "account_id": 1,
          "amount": "223.5",
          "details": {
            "amount_by_reason": {
              "dryclean": "100 RUB",
              "test_reason_1": "123.5 RUB"
            }
          },
          "event_at": "2018-11-30T19:31:35.000000+00:00"
        }
      ],
      "kind": "subvention_journal",
      "service": "billing-subventions",
      "status": "new",
      "tags": [
        "system://parent_doc_id/1000",
        "journal_ancestor_doc_id/1000",
        "taxi/alias_id/some_alias_id"
      ]
    }
  ],
  "expected_created_orders_docs": [
    {
      "orders": [
        {
          "data": {
            "base_doc_id": 1000,
            "driver_income": {
              "alias_id": "some_alias_id",
              "components": [
                {
                  "amount": "223.5000",
                  "currency": "RUB",
                  "kind": "subvention/misc"
                }
              ],
              "driver": {
                "db_id": "db_id",
                "driver_uuid": "uuid"
              },
              "order_event_at": "2018-07-02T00:00:00.750000+00:00",
              "payload": {
                "billing_park_commission_flow": true
              }
            },
            "event_version": 1000,
            "payments": [
              {
                "amount": "223.5000",
                "billing_client_id": "billing_client_id",
                "contract_id": "123456",
                "currency": "RUB",
                "invoice_date": "2018-07-02T00:40:00.750000+00:00",
                "payload": {
                  "alias_id": "some_alias_id",
                  "detailed_product": "subsidy_misc",
                  "due": "2018-07-02T00:00:00.750000+00:00",
                  "is_payable": false,
                  "order_id": "some_order_id",
                  "payload": {
                    "amount_details": {
                      "base_amount": "223.5000",
                      "base_currency": "RUB",
                      "contract_currency_rate": "1.00000",
                      "donate_multiplier": "1.0000"
                    },
                    "base_doc_id": 1000,
                    "driver_details": {
                      "clid": "clid",
                      "db_id": "db_id",
                      "uuid": "uuid"
                    },
                    "nearest_zone": "moscow"
                  },
                  "tariff_class": "econom",
                  "transaction_type": "payment"
                },
                "payment_kind": "subvention"
              }
            ],
            "schema_version": "v3",
            "topic_begin_at": "2018-07-02T00:00:00.750000+00:00"
          },
          "event_at": "2018-11-30T19:31:35.000000+00:00",
          "external_ref": "1000",
          "kind": "subvention",
          "tags": [
            "taxi/alias_id/some_alias_id"
          ],
          "topic": "alias_id/some_alias_id/subvention/manual"
        }
      ]
    }
  ],
  "expected_docs_updated_events": [
    {
      "data": {
        "park_commission_rule_status": "not_found"
      },
      "doc_id": 1000,
      "entry_ids": [],
      "idempotency_key": "subvention_park_commission_rule",
      "revision": 1,
      "status": "new"
    }
  ],
  "expected_entities": [
    {
      "external_id": "taximeter_driver_id/e414001e44434a00a93b65cc49548d5e/7bc343fc873a49159483e487663ba761",
      "kind": "driver"
    }
  ],
  "replication_contracts": [
    {
      "CONTRACT_TYPE": 9,
      "COUNTRY": 123,
      "CURRENCY": "USD",
      "DT": "2019-10-01 00:00:00",
      "END_DT": null,
      "EXTERNAL_ID": "GEN/123456",
      "FINISH_DT": null,
      "ID": 123456,
      "IND_BEL_NDS": null,
      "IND_BEL_NDS_PERCENT": null,
      "IS_ACTIVE": 1,
      "IS_CANCELLED": 0,
      "IS_DEACTIVATED": null,
      "IS_FAXED": 1,
      "IS_SIGNED": 1,
      "IS_SUSPENDED": 0,
      "LINK_CONTRACT_ID": null,
      "NDS": 0,
      "NDS_FOR_RECEIPT": null,
      "NETTING": null,
      "NETTING_PCT": null,
      "OFFER_ACCEPTED": null,
      "PARTNER_COMMISSION_PCT": "5",
      "PARTNER_COMMISSION_PCT2": null,
      "PAYMENT_TYPE": null,
      "PERSON_ID": 8486204,
      "SERVICES": [
        111,
        128
      ]
    },
    {
      "CONTRACT_TYPE": 87,
      "COUNTRY": 123,
      "CURRENCY": "USD",
      "DT": "2019-10-01 00:00:00",
      "END_DT": null,
      "EXTERNAL_ID": "SPEND/123456",
      "FINISH_DT": null,
      "ID": 123457,
      "IND_BEL_NDS": null,
      "IND_BEL_NDS_PERCENT": null,
      "IS_ACTIVE": 1,
      "IS_CANCELLED": 0,
      "IS_DEACTIVATED": null,
      "IS_FAXED": 1,
      "IS_SIGNED": 1,
      "IS_SUSPENDED": 0,
      "LINK_CONTRACT_ID": 123456,
      "NDS": 0,
      "NDS_FOR_RECEIPT": null,
      "NETTING": null,
      "NETTING_PCT": null,
      "OFFER_ACCEPTED": null,
      "PARTNER_COMMISSION_PCT": "5",
      "PARTNER_COMMISSION_PCT2": null,
      "PAYMENT_TYPE": null,
      "PERSON_ID": 8486204,
      "SERVICES": [
        651,
        137
      ]
    }
  ]
}
