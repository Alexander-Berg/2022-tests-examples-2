FUNC(getMainStringFromExperiment,ARGS((exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>)),B(CR(str=SL(2,16,2,76,T(SL(2,17,2,30,B("main",in,FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>))),SL(2,34,2,71,T(U(?,SL(2,35,2,51,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,SL(2,39,2,45,"main")),.,F(str)))),SL(2,61,2,65,U(*,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,SL(2,39,2,45,"main")),.,F(str)))),SL(2,67,2,71," "))),SL(2,73,2,76," "))))));FUNC(getToValueFromExperiment,ARGS((exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>)),B(CR(val=SL(6,16,6,76,T(SL(6,17,6,28,B("to",in,FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>))),SL(6,32,6,69,T(U(?,SL(6,33,6,47,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,SL(6,37,6,41,"to")),.,F(val)))),SL(6,57,6,61,U(*,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,SL(6,37,6,41,"to")),.,F(val)))),SL(6,63,6,69,0.001000))),SL(6,71,6,76,0.001000))))));FUNC(makeSetcarMetaRounded,ARGS((effective_surge,double),(is_cargo_category,bool)),B(IF(SL(10,6,10,50,B("setcar_show_surge_or_surcharge",in,B(fix,.,F(exps)))),SV(show_surge_or_surcharge,SL(11,34,11,113,B(FC(getMainStringFromExperiment,NT(exp=SL(11,66,11,108,B(B(fix,.,F(exps)),.,SL(11,75,11,107,"setcar_show_surge_or_surcharge")))),R(str=std::string)),.,F(str))));SV(fact_surge,SL(13,21,15,13,T(SL(13,22,13,42,B(U(*,B(ride,.,F(price))),>,0.000100)),SL(14,10,15,8,B(SL(14,11,14,40,B(U(*,B(ride,.,F(price))),+,FA(effective_surge,double))),/,U(*,B(ride,.,F(price))))),SL(15,10,15,13,1.000000))));SV(round_fact_surge,SL(16,27,16,61,B(SL(16,37,16,54,B(VA(fact_surge),-,0.050000)),round_to,0.100000)));SV(round_delta,SL(17,22,17,68,B(FA(effective_surge,double),round_to,B(fix,.,F(rounding_factor)))));IF(SL(19,8,19,99,B(B(B(VA(show_surge_or_surcharge),==,"show_surge"),&&,B(VA(round_fact_surge),>,1.000100)),&&,U(!,FA(is_cargo_category,bool)))),CR(meta=SL(20,22,22,7,MAP("setcar.show_surge"=VA(round_fact_surge)))),IF(SL(23,15,23,109,B(SL(23,16,23,80,B(FA(is_cargo_category,bool),||,B(VA(show_surge_or_surcharge),==,"show_surcharge"))),&&,B(FA(effective_surge,double),>,0.000100))),CR(meta=SL(24,22,26,7,MAP("setcar.show_surcharge"=VA(round_delta)))))));CR(meta=SL(29,18,29,20,MAP()))));FUNC(makeSetcarMeta,ARGS((delta,double),(is_cargo_category,bool),(price_after_surge,double)),B(IF(SL(33,6,33,50,B("setcar_show_surge_or_surcharge",in,B(fix,.,F(exps)))),SV(show_surge_or_surcharge,SL(34,34,34,113,B(FC(getMainStringFromExperiment,NT(exp=SL(34,66,34,108,B(B(fix,.,F(exps)),.,SL(34,75,34,107,"setcar_show_surge_or_surcharge")))),R(str=std::string)),.,F(str))));SV(fact_surge,SL(36,21,38,13,T(SL(36,22,36,42,B(U(*,B(ride,.,F(price))),>,0.000100)),SL(37,10,38,8,B(FA(price_after_surge,double),/,U(*,B(ride,.,F(price))))),SL(38,10,38,13,1.000000))));SV(round_fact_surge,SL(39,27,39,63,B(SL(39,37,39,55,B(VA(fact_surge),-,0.005000)),round_to,0.010000)));SV(round_delta,SL(40,22,40,58,B(FA(delta,double),round_to,B(fix,.,F(rounding_factor)))));IF(SL(42,8,42,98,B(B(B(VA(show_surge_or_surcharge),==,"show_surge"),&&,B(VA(round_fact_surge),>,1.000100)),&&,U(!,FA(is_cargo_category,bool)))),CR(meta=SL(43,22,45,7,MAP("setcar.show_surge"=VA(round_fact_surge)))),IF(SL(46,15,46,105,B(SL(46,16,46,80,B(FA(is_cargo_category,bool),||,B(VA(show_surge_or_surcharge),==,"show_surcharge"))),&&,B(VA(round_delta),>,0.000100))),CR(meta=SL(47,22,49,7,MAP("setcar.show_surcharge"=VA(round_delta)))))));CR(meta=SL(52,18,52,20,MAP()))));FUNC(calculateSyntheticSurge,ARGS((delta,double)),B(CR(res=SL(56,17,56,83,T(SL(56,18,56,38,B(U(*,B(ride,.,F(price))),>,0.000100)),SL(56,42,56,78,B(SL(56,43,56,62,B(U(*,B(ride,.,F(price))),+,FA(delta,double))),/,U(*,B(ride,.,F(price))))),SL(56,80,56,83,1.000000))))));IF(SL(60,4,60,26,B(B(fix,.,F(zone)),==,"boryasvo")),CR(boarding=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(boarding)),destination_waiting=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(destination_waiting)),distance=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(distance)),requirements=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(requirements)),time=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(time)),transit_waiting=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(transit_waiting)),waiting=B(SL(61,9,61,19,B(ride,.,F(price))),.,F(waiting))));IF(U(?,SL(65,4,65,26,B(fix,.,F(forced_skip_label)))),IF(SL(66,6,66,97,B(U(*,B(fix,.,F(forced_skip_label))),==,handlers::libraries::pricing_functions::ForcedSkipLabel::kWithoutSurge)),CR(boarding=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(boarding)),destination_waiting=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(destination_waiting)),distance=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(distance)),requirements=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(requirements)),time=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(time)),transit_waiting=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(transit_waiting)),waiting=B(SL(67,11,67,21,B(ride,.,F(price))),.,F(waiting)))));SV(DEFAULT_ALPHA,SL(71,20,71,21,1.000000));SV(DEFAULT_BETA,SL(72,19,72,20,0.000000));SV(DEFAULT_SURCHARGE,SL(73,24,73,25,0.000000));SV(orig_surge,SL(75,17,75,39,B(B(fix,.,F(surge_params)),.,F(value))));SV(alpha,SL(77,12,77,121,T(SL(77,13,77,28,B(VA(orig_surge),>=,1.000000)),SL(77,32,77,106,T(U(?,SL(77,34,77,67,B(B(fix,.,F(surge_params)),.,F(surcharge_alpha)))),SL(77,81,77,89,U(*,B(B(fix,.,F(surge_params)),.,F(surcharge_alpha)))),SL(77,91,77,104,VA(DEFAULT_ALPHA)))),SL(77,108,77,121,VA(DEFAULT_ALPHA)))));SV(beta,SL(78,11,78,115,T(SL(78,12,78,27,B(VA(orig_surge),>=,1.000000)),SL(78,31,78,101,T(U(?,SL(78,33,78,65,B(B(fix,.,F(surge_params)),.,F(surcharge_beta)))),SL(78,78,78,85,U(*,B(B(fix,.,F(surge_params)),.,F(surcharge_beta)))),SL(78,87,78,99,VA(DEFAULT_BETA)))),SL(78,103,78,115,VA(DEFAULT_BETA)))));SV(surcharge,SL(79,16,79,135,T(SL(79,17,79,32,B(VA(orig_surge),>=,1.000000)),SL(79,36,79,116,T(U(?,SL(79,38,79,65,B(B(fix,.,F(surge_params)),.,F(surcharge)))),SL(79,83,79,95,U(*,B(B(fix,.,F(surge_params)),.,F(surcharge)))),SL(79,97,79,114,VA(DEFAULT_SURCHARGE)))),SL(79,118,79,135,VA(DEFAULT_SURCHARGE)))));SV(surge,SL(82,12,82,46,T(SL(82,13,82,28,B(VA(orig_surge),>=,1.000000)),SL(82,32,82,43,VA(orig_surge)),SL(82,45,82,46,1.000000))));SV(alpha_surge_beta,SL(84,23,84,43,B(B(VA(alpha),*,VA(surge)),+,VA(beta))));SV(is_cargo_category,SL(86,24,86,112,B(B("cargo_categories_list",in,B(fix,.,F(exps))),&&,B(B(fix,.,F(category)),in,B(B(fix,.,F(exps)),.,SL(86,88,86,111,"cargo_categories_list"))))));SV(waitings_coeff,SL(87,21,87,82,T(SL(87,22,87,69,B(B(B(fix,.,F(country_code2)),==,"RU"),&&,U(!,VA(is_cargo_category)))),SL(87,73,87,79,VA(surge)),SL(87,81,87,82,1.000000))));SV(waiting,SL(89,14,89,49,B(VA(waitings_coeff),*,B(B(ride,.,F(price)),.,F(waiting)))));SV(transit_waiting,SL(90,22,90,65,B(VA(waitings_coeff),*,B(B(ride,.,F(price)),.,F(transit_waiting)))));SV(destination_waiting,SL(91,26,91,73,B(VA(waitings_coeff),*,B(B(ride,.,F(price)),.,F(destination_waiting)))));IF(U(?,SL(94,4,94,41,B(fix,.,F(previously_calculated_categories)))),IF(SL(95,6,95,25,B(B(fix,.,F(category)),in,U(*,B(fix,.,F(previously_calculated_categories))))),SV(meta,SL(96,15,96,63,B(B(B(B(B(U(*,B(fix,.,F(previously_calculated_categories))),.,SL(96,19,96,31,B(fix,.,F(category)))),.,F(user)),.,F(final_prices)),.,SL(96,51,96,57,"main")),.,F(meta))));IF(SL(98,8,98,35,B("setcar.show_surge",in,VA(meta))),SV(coeff,SL(99,20,99,45,B(VA(meta),.,SL(99,25,99,44,"setcar.show_surge"))));SV(surge_delta_raw,SL(101,30,102,75,B(B(B(B(B(VA(coeff),*,SL(101,39,101,124,B(B(B(B(B(ride,.,F(price)),.,F(boarding)),+,B(B(ride,.,F(price)),.,F(distance))),+,B(B(ride,.,F(price)),.,F(time))),+,B(B(ride,.,F(price)),.,F(requirements))))),+,VA(waiting)),+,VA(transit_waiting)),+,VA(destination_waiting)),-,U(*,B(ride,.,F(price))))));SV(synthetic_surge,SL(104,30,104,80,B(FC(calculateSyntheticSurge,NT(delta=SL(104,60,104,75,VA(surge_delta_raw))),R(res=double)),.,F(res))));CR(boarding=SL(107,23,107,50,B(VA(coeff),*,B(B(ride,.,F(price)),.,F(boarding)))),destination_waiting=SL(113,34,113,53,VA(destination_waiting)),distance=SL(108,23,108,50,B(VA(coeff),*,B(B(ride,.,F(price)),.,F(distance)))),metadata=SL(114,23,119,13,MAP("setcar.show_surge"=VA(coeff),"surge_delta_raw"=VA(surge_delta_raw),"surge_delta"=B(VA(surge_delta_raw),round_to,B(fix,.,F(rounding_factor))),"synthetic_surge"=VA(synthetic_surge))),requirements=SL(110,27,110,58,B(VA(coeff),*,B(B(ride,.,F(price)),.,F(requirements)))),time=SL(109,19,109,42,B(VA(coeff),*,B(B(ride,.,F(price)),.,F(time)))),transit_waiting=SL(112,30,112,45,VA(transit_waiting)),waiting=SL(111,22,111,29,VA(waiting))));IF(SL(123,8,123,39,B("setcar.show_surcharge",in,VA(meta))),SV(addition,SL(124,23,124,52,B(VA(meta),.,SL(124,28,124,51,"setcar.show_surcharge"))));SV(surge_delta_raw,SL(126,30,129,66,B(B(B(B(B(B(VA(addition),+,VA(waiting)),-,B(B(ride,.,F(price)),.,F(waiting))),+,VA(transit_waiting)),-,B(B(ride,.,F(price)),.,F(transit_waiting))),+,VA(destination_waiting)),-,B(B(ride,.,F(price)),.,F(destination_waiting)))));SV(synthetic_surge,SL(131,30,131,80,B(FC(calculateSyntheticSurge,NT(delta=SL(131,60,131,75,VA(surge_delta_raw))),R(res=double)),.,F(res))));CR(boarding=SL(134,23,134,53,B(B(B(ride,.,F(price)),.,F(boarding)),+,VA(addition))),destination_waiting=SL(137,34,137,53,VA(destination_waiting)),metadata=SL(138,23,143,13,MAP("setcar.show_surcharge"=VA(addition),"surge_delta_raw"=VA(surge_delta_raw),"surge_delta"=B(VA(surge_delta_raw),round_to,B(fix,.,F(rounding_factor))),"synthetic_surge"=VA(synthetic_surge))),transit_waiting=SL(136,30,136,45,VA(transit_waiting)),waiting=SL(135,22,135,29,VA(waiting))))));SV(boarding,SL(149,15,149,72,B(B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(boarding))),+,B(VA(beta),*,VA(surcharge)))));SV(distance,SL(150,15,150,53,B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(distance)))));SV(time,SL(151,11,151,45,B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(time)))));SV(requirements,SL(152,19,152,61,B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(requirements)))));SV(price_after_surge,SL(155,24,161,36,B(B(B(B(B(B(VA(boarding),+,VA(distance)),+,VA(time)),+,VA(requirements)),+,B(B(ride,.,F(price)),.,F(waiting))),+,B(B(ride,.,F(price)),.,F(transit_waiting))),+,B(B(ride,.,F(price)),.,F(destination_waiting)))));SV(delta,SL(162,12,162,43,B(VA(price_after_surge),-,U(*,B(ride,.,F(price))))));IF(SL(165,4,165,32,B("surge_rounding",in,B(fix,.,F(exps)))),SV(surge_rounding_factor,SL(166,30,166,90,B(FC(getToValueFromExperiment,NT(exp=SL(166,59,166,85,B(B(fix,.,F(exps)),.,SL(166,68,166,84,"surge_rounding")))),R(val=double)),.,F(val))));SV(effective_surge,SL(167,24,167,62,B(VA(delta),round_to,VA(surge_rounding_factor))));SV(meta1,SL(169,14,169,110,B(FC(makeSetcarMetaRounded,NT(effective_surge=SL(169,52,169,67,VA(effective_surge)),is_cargo_category=SL(169,87,169,104,VA(is_cargo_category))),R(meta=std::unordered_map<std::string,double>)),.,F(meta))));SV(surge_delta_raw,SL(171,24,178,19,B(B(B(B(B(B(B(B(B(B(ride,.,F(price)),.,F(boarding)),+,VA(effective_surge)),+,B(B(ride,.,F(price)),.,F(distance))),+,B(B(ride,.,F(price)),.,F(time))),+,B(B(ride,.,F(price)),.,F(requirements))),+,VA(waiting)),+,VA(transit_waiting)),+,VA(destination_waiting)),-,U(*,B(ride,.,F(price))))));SV(synthetic_surge,SL(180,24,180,74,B(FC(calculateSyntheticSurge,NT(delta=SL(180,54,180,69,VA(surge_delta_raw))),R(res=double)),.,F(res))));SV(meta2,SL(182,14,186,3,MAP("surge_delta_raw"=VA(surge_delta_raw),"surge_delta"=B(VA(surge_delta_raw),round_to,B(fix,.,F(rounding_factor))),"synthetic_surge"=VA(synthetic_surge))));CR(boarding=SL(189,15,189,52,B(B(B(ride,.,F(price)),.,F(boarding)),+,VA(effective_surge))),destination_waiting=SL(192,26,192,45,VA(destination_waiting)),metadata=SL(193,15,194,2,B(VA(meta1),+,VA(meta2))),transit_waiting=SL(191,22,191,37,VA(transit_waiting)),waiting=SL(190,14,190,21,VA(waiting))));SV(meta1,SL(197,12,197,118,B(FC(makeSetcarMeta,NT(delta=SL(197,107,197,112,VA(delta)),is_cargo_category=SL(197,82,197,99,VA(is_cargo_category)),price_after_surge=SL(197,45,197,62,VA(price_after_surge))),R(meta=std::unordered_map<std::string,double>)),.,F(meta))));SV(surge_delta_raw,SL(199,22,206,17,B(B(B(B(B(B(B(VA(boarding),+,VA(distance)),+,VA(time)),+,VA(requirements)),+,VA(waiting)),+,VA(transit_waiting)),+,VA(destination_waiting)),-,U(*,B(ride,.,F(price))))));SV(synthetic_surge,SL(208,22,208,72,B(FC(calculateSyntheticSurge,NT(delta=SL(208,52,208,67,VA(surge_delta_raw))),R(res=double)),.,F(res))));SV(meta2,SL(210,12,214,1,MAP("surge_delta_raw"=VA(surge_delta_raw),"surge_delta"=B(VA(surge_delta_raw),round_to,B(fix,.,F(rounding_factor))),"synthetic_surge"=VA(synthetic_surge))));CR(boarding=SL(217,13,217,21,VA(boarding)),destination_waiting=SL(223,24,223,43,VA(destination_waiting)),distance=SL(218,13,218,21,VA(distance)),metadata=SL(224,13,225,0,B(VA(meta1),+,VA(meta2))),requirements=SL(220,17,220,29,VA(requirements)),time=SL(219,9,219,13,VA(time)),transit_waiting=SL(222,20,222,35,VA(transit_waiting)),waiting=SL(221,12,221,19,VA(waiting)))
