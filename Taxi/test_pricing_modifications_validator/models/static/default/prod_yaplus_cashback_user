FUNC(getAvailableCashback,ARGS(),B(IF(U(?,B(B(fix,.,F(category_data)),.,F(yaplus_coeff))),CR(enabled=true,price_decreasing_coeff=U(*,B(B(fix,.,F(category_data)),.,F(yaplus_coeff))),rate=B(1.000000,-,U(*,B(B(fix,.,F(category_data)),.,F(yaplus_coeff))))));CR(enabled=false,price_decreasing_coeff=1.000000,rate=0.000000)));FUNC(getMinimalPrimaryPayment,ARGS(),B(SV(minimal_primary_sum_exp,B("composite_payment_minimal_primary_sum",in,B(fix,.,F(exps))));IF(U(!,VA(minimal_primary_sum_exp)),CR(res=0.000000));CR(res=B(fix,.,F(rounding_factor)))));FUNC(max,ARGS((a,double),(b,double)),B(CR(res=T(B(FA(a,double),>,FA(b,double)),FA(a,double),FA(b,double)))));FUNC(getComposite,ARGS(),B(SV(cashback_for_composite_enabled,B("cashback_for_composite_enabled",in,B(fix,.,F(exps))));IF(U(!,VA(cashback_for_composite_enabled)),CR(enabled=false,meta=MAP(),paid_by_card=0.000000));IF(U(?,B(fix,.,F(complements))),IF(U(?,B(U(*,B(fix,.,F(complements))),.,F(personal_wallet))),SV(min_primary_payment,B(FC(getMinimalPrimaryPayment,NT(),R(res=double)),.,F(res)));SV(display_price,T(B(U(*,B(ride,.,F(price))),>,B(U(*,B(U(*,B(fix,.,F(complements))),.,F(personal_wallet))),.,F(balance))),B(U(*,B(ride,.,F(price))),-,B(U(*,B(U(*,B(fix,.,F(complements))),.,F(personal_wallet))),.,F(balance))),0.000000));SV(display_price_rounded,B(VA(display_price),round_to,B(fix,.,F(rounding_factor))));SV(display_price_rounded_checked,B(FC(max,NT(a=VA(display_price_rounded),b=VA(min_primary_payment)),R(res=double)),.,F(res)));SV(display_min_price,T(B(B(B(fix,.,F(tariff)),.,F(minimum_price)),>,B(U(*,B(U(*,B(fix,.,F(complements))),.,F(personal_wallet))),.,F(balance))),B(B(B(fix,.,F(tariff)),.,F(minimum_price)),-,B(U(*,B(U(*,B(fix,.,F(complements))),.,F(personal_wallet))),.,F(balance))),0.000000));SV(display_min_price_rounded,B(VA(display_min_price),round_to,B(fix,.,F(rounding_factor))));SV(composite_meta,MAP("cashback_for_composite"=1.000000,"display_price"=VA(display_price_rounded_checked),"display_min_price"=VA(display_min_price_rounded),"wallet_balance"=B(U(*,B(U(*,B(fix,.,F(complements))),.,F(personal_wallet))),.,F(balance))));CR(enabled=true,meta=VA(composite_meta),paid_by_card=VA(display_price_rounded_checked))));CR(enabled=false,meta=MAP(),paid_by_card=0.000000)));FUNC(makeCouponMeta,ARGS(),B(IF(U(?,B(fix,.,F(coupon))),IF(B(U(*,B(fix,.,F(coupon))),.,F(valid)),SV(using_user_meta_enabled,B("using_user_meta_enabled",in,B(fix,.,F(exps))));IF(VA(using_user_meta_enabled),CR(meta=MAP("cashback_with_coupon"=1.000000),ret=false),CR(meta=MAP(),ret=true))));CR(meta=MAP(),ret=false)));SV(unite_total_price_enabled,B("cashback_unite_total_price",in,B(fix,.,F(exps))));IF(U(!,VA(unite_total_price_enabled)),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(U(?,B(fix,.,F(payment_type))),SV(corp_type,B(U(*,B(fix,.,F(payment_type))),==,"corp"));SV(wallet_type,B(U(*,B(fix,.,F(payment_type))),==,"personal_wallet"));SV(corp_acc_type,B(U(*,B(fix,.,F(payment_type))),==,"coop_account"));SV(bad_type,B(B(VA(corp_type),||,VA(wallet_type)),||,VA(corp_acc_type)));IF(VA(bad_type),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(cashback_params,FC(getAvailableCashback,NT(),R(enabled=bool,price_decreasing_coeff=double,rate=double)));IF(B(VA(cashback_params),.,F(enabled)),IF(B(U(*,B(fix,.,F(payment_type))),==,"cash"),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(B(B(VA(cashback_params),.,F(price_decreasing_coeff)),<,0.010000),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(B(B(VA(cashback_params),.,F(rate)),<,0.010000),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(cashback_for_plus_available,B("cashback_for_plus_availability",in,B(fix,.,F(exps))));IF(U(!,VA(cashback_for_plus_available)),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(meta_return,FC(makeCouponMeta,NT(),R(meta=std::unordered_map<std::string,double>,ret=bool)));IF(B(VA(meta_return),.,F(ret)),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(meta1,B(VA(meta_return),.,F(meta)));SV(composite,FC(getComposite,NT(),R(enabled=bool,meta=std::unordered_map<std::string,double>,paid_by_card=double)));SV(cashback_rate,B(VA(cashback_params),.,F(rate)));SV(price_decreasing_coeff,B(VA(cashback_params),.,F(price_decreasing_coeff)));SV(cashback_coeff,B(VA(cashback_rate),/,VA(price_decreasing_coeff)));SV(rounded_total_price,B(U(*,B(ride,.,F(price))),round_to,B(fix,.,F(rounding_factor))));SV(rounded_base_price,T(B(VA(composite),.,F(enabled)),B(VA(composite),.,F(paid_by_card)),VA(rounded_total_price)));SV(cashback_price,B(VA(rounded_base_price),*,VA(cashback_rate)));SV(rounded_cashback_price,B(VA(cashback_price),round_to,B(fix,.,F(rounding_factor))));SV(rounded_new_ride_price,B(VA(rounded_total_price),-,VA(rounded_cashback_price)));SV(new_price_decreasing_coeff,T(B(U(*,B(ride,.,F(price))),>=,1.000000),B(VA(rounded_new_ride_price),/,U(*,B(ride,.,F(price)))),VA(price_decreasing_coeff)));IF(U(!,B(B(fix,.,F(user_data)),.,F(has_yaplus))),SV(meta2,MAP("possible_cashback_rate"=VA(cashback_rate),"possible_cashback_fixed_price"=VA(rounded_cashback_price)));CR(metadata=VA(meta2)));IF(U(!,B(B(fix,.,F(user_data)),.,F(has_cashback_plus))),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));IF(B(B(VA(rounded_new_ride_price),<=,0.000000),&&,B(VA(rounded_cashback_price),>,0.000000)),SV(meta2,MAP("cashback_fixed_price"=0.000000,"cashback_fixed_price_for_driver"=0.000000,"unite_total_price_enabled"=1.000000));CR(metadata=VA(meta2)));SV(payment_type_is_cash,B("payment_type_is_cash",in,B(B(ride,.,F(ride)),.,F(user_options))));IF(VA(payment_type_is_cash),SV(meta2,MAP("cashback_fixed_price"=0.000000));CR(boarding=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(boarding)),destination_waiting=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(destination_waiting)),distance=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(distance)),metadata=B(VA(meta1),+,VA(meta2)),requirements=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(requirements)),time=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(time)),transit_waiting=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(transit_waiting)),waiting=B(B(B(ride,.,F(price)),*,VA(new_price_decreasing_coeff)),.,F(waiting))));SV(meta2,MAP("unite_total_price_enabled"=1.000000,"plus_cashback_rate"=VA(cashback_rate),"cashback_calc_coeff"=0.000000,"cashback_fixed_price"=VA(rounded_cashback_price),"user_ride_price"=VA(rounded_new_ride_price),"user_total_price"=VA(rounded_total_price)));CR(metadata=B(B(VA(meta1),+,B(VA(composite),.,F(meta))),+,VA(meta2)))));CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting)))
