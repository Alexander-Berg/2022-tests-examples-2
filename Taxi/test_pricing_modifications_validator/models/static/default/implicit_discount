FUNC(getMainStrFromExperiment,ARGS((exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>)),B(CR(str=T(B("main",in,FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>)),T(U(?,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,"main"),.,F(str))),U(*,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,"main"),.,F(str)))," ")," "))));FUNC(abs,ARGS((val,double)),B(CR(res=T(B(FA(val,double),<,0.000000),U(-,FA(val,double)),FA(val,double)))));FUNC(min,ARGS((a,double),(b,double)),B(CR(res=T(B(FA(a,double),<,FA(b,double)),FA(a,double),FA(b,double)))));FUNC(max,ARGS((a,double),(b,double)),B(CR(res=T(B(FA(a,double),>,FA(b,double)),FA(a,double),FA(b,double)))));FUNC(minBetweenOptionals,ARGS((a,std::optional<double>),(b_is_set,bool),(b_value,double)),B(IF(U(?,FA(a,std::optional<double>)),IF(FA(b_is_set,bool),CR(is_set=true,value=B(FC(min,NT(a=U(*,FA(a,std::optional<double>)),b=FA(b_value,double)),R(res=double)),.,F(res))));CR(is_set=true,value=U(*,FA(a,std::optional<double>))));CR(is_set=FA(b_is_set,bool),value=FA(b_value,double))));FUNC(calculateHyperbolaDiscountPercent,ARGS((hyperbolas,clients::discounts::HyperbolasData),(price,double)),B(SV(hyperbola,T(B(FA(price,double),<,B(FA(hyperbolas,clients::discounts::HyperbolasData),.,F(threshold))),B(FA(hyperbolas,clients::discounts::HyperbolasData),.,F(hyperbola_lower)),B(FA(hyperbolas,clients::discounts::HyperbolasData),.,F(hyperbola_upper))));IF(B(B(FC(abs,NT(val=B(FA(price,double),+,B(VA(hyperbola),.,F(c)))),R(res=double)),.,F(res)),<,0.000100),CR(res=0.000000));CR(res=B(B(VA(hyperbola),.,F(p)),+,B(B(VA(hyperbola),.,F(a)),/,B(FA(price,double),+,B(VA(hyperbola),.,F(c))))))));FUNC(processTableElement,ARGS((elem,clients::discounts::TableDataA),(first_iteration,bool),(has_result,bool),(prev_elem_coeff,double),(prev_elem_price,double),(price,double),(result,double)),B(IF(FA(has_result,bool),CR(first_iteration=false,has_result=true,prev_elem_coeff=B(FA(elem,clients::discounts::TableDataA),.,F(coeff)),prev_elem_price=B(FA(elem,clients::discounts::TableDataA),.,F(price)),price=FA(price,double),result=FA(result,double)));IF(B(FA(first_iteration,bool),&&,B(FA(price,double),<,B(FA(elem,clients::discounts::TableDataA),.,F(price)))),CR(first_iteration=false,has_result=true,prev_elem_coeff=B(FA(elem,clients::discounts::TableDataA),.,F(coeff)),prev_elem_price=B(FA(elem,clients::discounts::TableDataA),.,F(price)),price=FA(price,double),result=B(FA(elem,clients::discounts::TableDataA),.,F(coeff))));IF(B(B(U(!,FA(first_iteration,bool)),&&,B(FA(prev_elem_price,double),<=,FA(price,double))),&&,B(FA(price,double),<,B(FA(elem,clients::discounts::TableDataA),.,F(price)))),IF(B(B(FC(abs,NT(val=B(B(FA(elem,clients::discounts::TableDataA),.,F(price)),-,FA(prev_elem_price,double))),R(res=double)),.,F(res)),<,0.000100),CR(first_iteration=false,has_result=true,prev_elem_coeff=B(FA(elem,clients::discounts::TableDataA),.,F(coeff)),prev_elem_price=B(FA(elem,clients::discounts::TableDataA),.,F(price)),price=FA(price,double),result=0.000000));CR(first_iteration=false,has_result=true,prev_elem_coeff=B(FA(elem,clients::discounts::TableDataA),.,F(coeff)),prev_elem_price=B(FA(elem,clients::discounts::TableDataA),.,F(price)),price=FA(price,double),result=B(FA(prev_elem_coeff,double),+,B(B(B(B(FA(elem,clients::discounts::TableDataA),.,F(coeff)),-,FA(prev_elem_coeff,double)),*,B(FA(price,double),-,FA(prev_elem_price,double))),/,B(B(FA(elem,clients::discounts::TableDataA),.,F(price)),-,FA(prev_elem_price,double))))));CR(first_iteration=false,has_result=false,prev_elem_coeff=B(FA(elem,clients::discounts::TableDataA),.,F(coeff)),prev_elem_price=B(FA(elem,clients::discounts::TableDataA),.,F(price)),price=FA(price,double),result=FA(result,double))));FUNC(calculateTableDiscountPercent,ARGS((price,double),(table,std::vector<clients::discounts::TableDataA>)),B(SV(process_table_result,FL(FA(table,std::vector<clients::discounts::TableDataA>),elem,NT(first_iteration=true,has_result=false,prev_elem_coeff=0.000000,prev_elem_price=0.000000,price=FA(price,double),result=0.000000),FC(processTableElement,NT(elem=VA(elem),first_iteration=VA(first_iteration),has_result=VA(has_result),prev_elem_coeff=VA(prev_elem_coeff),prev_elem_price=VA(prev_elem_price),price=VA(price),result=VA(result)),R(first_iteration=bool,has_result=bool,prev_elem_coeff=double,prev_elem_price=double,price=double,result=double))));IF(B(VA(process_table_result),.,F(has_result)),CR(res=B(VA(process_table_result),.,F(result))));CR(res=B(VA(process_table_result),.,F(prev_elem_coeff)))));FUNC(applyNewbieCoefficients,ARGS((coeff,double),(restrictions,clients::discounts::DiscountRestrictions)),B(SV(newbie_max_coeff,T(U(?,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(newbie_max_coeff))),U(*,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(newbie_max_coeff))),1.000000));SV(newbie_num_coeff,T(U(?,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(newbie_num_coeff))),U(*,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(newbie_num_coeff))),0.000000));SV(completed_count,T(U(?,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(completed_on_special_conditions_count))),U(*,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(completed_on_special_conditions_count))),0.000000));CR(res=B(FA(coeff,double),*,B(VA(newbie_max_coeff),-,B(VA(newbie_num_coeff),*,VA(completed_count)))))));FUNC(normalizeToMinMax,ARGS((coeff,double),(ml_discount_restriction,double),(restrictions,clients::discounts::DiscountRestrictions)),B(SV(coeff_limited_to_max,B(FC(min,NT(a=B(FC(min,NT(a=FA(coeff,double),b=B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(max_discount_coeff))),R(res=double)),.,F(res)),b=FA(ml_discount_restriction,double)),R(res=double)),.,F(res)));CR(res=T(B(VA(coeff_limited_to_max),<,B(FA(restrictions,clients::discounts::DiscountRestrictions),.,F(min_discount_coeff))),0.000000,VA(coeff_limited_to_max)))));FUNC(normalizeByMaxAbsoluteValue,ARGS((coeff,double),(max_absolute_value,double),(price,double)),B(IF(B(B(FA(price,double),*,FA(coeff,double)),>,FA(max_absolute_value,double)),CR(res=B(FC(min,NT(a=B(FC(max,NT(a=B(FA(max_absolute_value,double),/,FA(price,double)),b=0.000000),R(res=double)),.,F(res)),b=1.000000),R(res=double)),.,F(res))));CR(res=FA(coeff,double))));FUNC(getPreviousCategory,ARGS(),B(IF(B(B(fix,.,F(category)),==,"business"),CR(res="econom"),IF(B(B(fix,.,F(category)),==,"uberselect"),CR(res="uberx")));CR(res=" ")));FUNC(fetchDiscountRestrictionFromPrevCategory,ARGS((discount_class,std::string)),B(IF(B(B("restrict_absolute_discount",in,B(fix,.,F(exps))),&&,B(FA(discount_class,std::string),==,"discounts-calculator")),SV(previous_category,B(FC(getPreviousCategory,NT(),R(res=std::string)),.,F(res)));IF(B(VA(previous_category),!=," "),SV(discount_type,B(FC(getMainStrFromExperiment,NT(exp=B(B(fix,.,F(exps)),.,"restrict_absolute_discount")),R(str=std::string)),.,F(str)));IF(B(VA(discount_type),==,"no_discount"),CR(is_set=true,value=0.000000));IF(B(VA(discount_type),==,"from_previous_category"),IF(U(?,B(fix,.,F(previously_calculated_categories))),IF(B(VA(previous_category),in,U(*,B(fix,.,F(previously_calculated_categories)))),IF(B("main",in,B(B(B(U(*,B(fix,.,F(previously_calculated_categories))),.,VA(previous_category)),.,F(user)),.,F(final_prices))),SV(econom_meta,B(B(B(B(B(U(*,B(fix,.,F(previously_calculated_categories))),.,VA(previous_category)),.,F(user)),.,F(final_prices)),.,"main"),.,F(meta)));IF(B("discount_delta_raw",in,VA(econom_meta)),SV(discount_delta_raw,B(VA(econom_meta),.,"discount_delta_raw"));CR(is_set=true,value=U(-,VA(discount_delta_raw)))))));CR(is_set=true,value=0.000000))));CR(is_set=false,value=0.000000)));FUNC(fetchDiscountRestrictionFromML,ARGS((discount_class,std::string)),B(IF(B(B("ml_model_restriction",in,B(fix,.,F(exps))),&&,B(FA(discount_class,std::string),==,"discounts-calculator")),SV(discount_type,B(FC(getMainStrFromExperiment,NT(exp=B(B(fix,.,F(exps)),.,"ml_model_restriction")),R(str=std::string)),.,F(str)));IF(B(VA(discount_type),==,"with_ml_restriction"),IF(U(?,B(fix,.,F(offer_statistics))),IF(B("discount",in,U(*,B(fix,.,F(offer_statistics)))),SV(ml_discount,B(U(*,B(fix,.,F(offer_statistics))),.,"discount"));CR(value=T(B(VA(ml_discount),<,0.000000),1.000000,VA(ml_discount)))))));CR(value=1.000000)));IF(U(?,B(fix,.,F(discount))),IF(U(?,B(U(*,B(fix,.,F(discount))),.,F(is_price_strikethrough))),IF(U(*,B(U(*,B(fix,.,F(discount))),.,F(is_price_strikethrough))),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting)))),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(restrictions,B(U(*,B(fix,.,F(discount))),.,F(restrictions)));IF(B(B(VA(restrictions),.,F(recalc_type)),==,clients::discounts::RecalcType::kSurgePrice),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(meta1,MAP("discount_price"=U(*,B(ride,.,F(price)))));SV(affected_price,B(B(B(U(*,B(ride,.,F(price))),-,B(B(ride,.,F(price)),.,F(waiting))),-,B(B(ride,.,F(price)),.,F(transit_waiting))),-,B(B(ride,.,F(price)),.,F(destination_waiting))));SV(percent,T(U(?,B(U(*,B(fix,.,F(discount))),.,F(calc_data_hyperbolas))),B(FC(calculateHyperbolaDiscountPercent,NT(hyperbolas=U(*,B(U(*,B(fix,.,F(discount))),.,F(calc_data_hyperbolas))),price=VA(affected_price)),R(res=double)),.,F(res)),T(U(?,B(U(*,B(fix,.,F(discount))),.,F(calc_data_table_data))),B(FC(calculateTableDiscountPercent,NT(price=VA(affected_price),table=U(*,B(U(*,B(fix,.,F(discount))),.,F(calc_data_table_data)))),R(res=double)),.,F(res)),0.000000)));SV(discount_class,T(U(?,B(U(*,B(fix,.,F(discount))),.,F(discount_class))),U(*,B(U(*,B(fix,.,F(discount))),.,F(discount_class)))," "));SV(econom_discount_restriction,FC(fetchDiscountRestrictionFromPrevCategory,NT(discount_class=VA(discount_class)),R(is_set=bool,value=double)));SV(max_absolute_value_opt,FC(minBetweenOptionals,NT(a=B(VA(restrictions),.,F(max_absolute_value)),b_is_set=B(VA(econom_discount_restriction),.,F(is_set)),b_value=B(VA(econom_discount_restriction),.,F(value))),R(is_set=bool,value=double)));SV(ml_discount_restriction,B(FC(fetchDiscountRestrictionFromML,NT(discount_class=VA(discount_class)),R(value=double)),.,F(value)));SV(coeff_initial,B(VA(percent),*,0.010000));SV(coeff1,B(FC(applyNewbieCoefficients,NT(coeff=VA(coeff_initial),restrictions=VA(restrictions)),R(res=double)),.,F(res)));SV(coeff2,B(FC(normalizeToMinMax,NT(coeff=VA(coeff1),ml_discount_restriction=VA(ml_discount_restriction),restrictions=VA(restrictions)),R(res=double)),.,F(res)));SV(coeff3,T(B(VA(max_absolute_value_opt),.,F(is_set)),B(FC(normalizeByMaxAbsoluteValue,NT(coeff=VA(coeff2),max_absolute_value=B(VA(max_absolute_value_opt),.,F(value)),price=VA(affected_price)),R(res=double)),.,F(res)),VA(coeff2)));IF(B(VA(coeff3),<=,0.000000),CR(metadata=VA(meta1)));SV(coeff_final,B(FC(min,NT(a=VA(coeff3),b=1.000000),R(res=double)),.,F(res)));IF(B(U(*,B(fix,.,F(discount))),.,F(is_cashback)),IF(T(U(?,B(fix,.,F(complements))),U(?,B(B(fix,.,F(complements)),.,F(personal_wallet))),false),CR(metadata=VA(meta1)));SV(meta2,MAP("cashback_rate"=VA(coeff_final)));SV(meta3,T(U(?,B(VA(restrictions),.,F(max_absolute_value))),MAP("cashback_max_value"=U(*,B(VA(restrictions),.,F(max_absolute_value)))),MAP()));IF(U(?,B(U(*,B(fix,.,F(discount))),.,F(description))),SV(meta4,T(B(B(U(*,B(U(*,B(fix,.,F(discount))),.,F(description))),==,"mc_cashback_ultima_plus"),||,B(U(*,B(U(*,B(fix,.,F(discount))),.,F(description))),==,"mastercard_comforts_cashback_summer")),MAP("cashback_sponsor:mastercard"=1.000000),MAP()));SV(meta5,T(B(U(*,B(U(*,B(fix,.,F(discount))),.,F(description))),==,"mastercard_otkrytie_ultima_cashback_2021"),MAP("cashback_sponsor:otkrytie_mastercard"=1.000000),MAP()));CR(metadata=B(B(B(B(VA(meta1),+,VA(meta2)),+,VA(meta3)),+,VA(meta4)),+,VA(meta5))));CR(metadata=B(B(VA(meta1),+,VA(meta2)),+,VA(meta3))));SV(delta,B(U(-,VA(affected_price)),*,VA(coeff_final)));SV(meta2,MAP("discount_value"=VA(coeff_final),"discount_delta_raw"=VA(delta)));SV(mult,B(1.000000,-,VA(coeff_final)));CR(boarding=B(B(B(ride,.,F(price)),.,F(boarding)),*,VA(mult)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(B(ride,.,F(price)),.,F(distance)),*,VA(mult)),metadata=B(VA(meta1),+,VA(meta2)),requirements=B(B(B(ride,.,F(price)),.,F(requirements)),*,VA(mult)),time=B(B(B(ride,.,F(price)),.,F(time)),*,VA(mult)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting)))
