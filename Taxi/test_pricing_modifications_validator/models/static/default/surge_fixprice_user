FUNC(max,ARGS((a,double),(b,double)),B(CR(res=T(B(FA(a,double),>,FA(b,double)),FA(a,double),FA(b,double)))));FUNC(min,ARGS((a,double),(b,double)),B(CR(res=T(B(FA(a,double),<,FA(b,double)),FA(a,double),FA(b,double)))));FUNC(getToValueFromExperiment,ARGS((exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>)),B(CR(val=T(B("to",in,FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>)),T(U(?,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,"to"),.,F(val))),U(*,B(B(FA(exp,std::unordered_map<std::string,lang::variables::ExperimentSubValue>),.,"to"),.,F(val))),0.001000),0.001000))));FUNC(getPreviousCategoryInfo,ARGS((category,std::string)),B(IF(U(?,B(fix,.,F(previously_calculated_categories))),IF(B(FA(category,std::string),in,U(*,B(fix,.,F(previously_calculated_categories)))),SV(meta,B(B(B(B(B(U(*,B(fix,.,F(previously_calculated_categories))),.,FA(category,std::string)),.,F(user)),.,F(final_prices)),.,"main"),.,F(meta)));IF(B(B("max_surge_delta_raw",in,VA(meta)),&&,B("price_after_surge",in,VA(meta))),CR(found=true,max_surge_delta_raw=B(VA(meta),.,"max_surge_delta_raw"),price_after_surge=B(VA(meta),.,"price_after_surge")))));CR(found=false,max_surge_delta_raw=0.000000,price_after_surge=0.000000)));FUNC(getPreviousCategory,ARGS(),B(SV(exp_name,"surge_uses_previously_calculated_categories");IF(B(B(VA(exp_name),in,B(fix,.,F(exps))),&&,B("increase_coeff",in,B(B(fix,.,F(exps)),.,VA(exp_name)))),IF(U(?,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),IF(B(U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),>,1.000000),IF(B(B(fix,.,F(category)),==,"business"),CR(coeff=U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),found=true,str="econom"),IF(B(B(fix,.,F(category)),==,"comfortplus"),CR(coeff=U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),found=true,str="business"),IF(B(B(fix,.,F(category)),==,"vip"),CR(coeff=U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),found=true,str="comfortplus"),IF(B(B(fix,.,F(category)),==,"uberselect"),CR(coeff=U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),found=true,str="uberx"),IF(B(B(fix,.,F(category)),==,"uberblack"),CR(coeff=U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"increase_coeff"),.,F(val))),found=true,str="uberselect")))))))));CR(coeff=1.000000,found=false,str=" ")));FUNC(getShowSurgeOrSurcharge,ARGS((delta,double),(forced_surcharge,bool)),B(SV(exp_name,"setcar_show_surge_or_surcharge");IF(B(B(VA(exp_name),in,B(fix,.,F(exps))),&&,B("main",in,B(B(fix,.,F(exps)),.,VA(exp_name)))),IF(U(?,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"main"),.,F(str))),IF(B(B(U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"main"),.,F(str))),==,"show_surge"),||,B(U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"main"),.,F(str))),==,"show_surcharge")),SV(fact_surge,T(B(U(*,B(ride,.,F(price))),>,0.000100),B(B(U(*,B(ride,.,F(price))),+,FA(delta,double)),/,U(*,B(ride,.,F(price)))),1.000000));SV(round_fact_surge,B(B(VA(fact_surge),-,0.050000),round_to,0.100000));SV(round_delta,B(FA(delta,double),round_to,B(fix,.,F(rounding_factor))));IF(B(B(U(!,FA(forced_surcharge,bool)),&&,B(U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"main"),.,F(str))),==,"show_surge")),&&,B(VA(round_fact_surge),>,1.000100)),CR(show_surcharge=false,show_surge=true,val=VA(round_fact_surge)));IF(B(B(FA(forced_surcharge,bool),||,B(U(*,B(B(B(B(fix,.,F(exps)),.,VA(exp_name)),.,"main"),.,F(str))),==,"show_surcharge")),&&,B(VA(round_delta),>,0.000100)),CR(show_surcharge=true,show_surge=false,val=VA(round_delta))))));CR(show_surcharge=false,show_surge=false,val=0.000000)));IF(U(?,B(fix,.,F(discount))),IF(B(B(B(U(*,B(fix,.,F(discount))),.,F(restrictions)),.,F(recalc_type)),==,clients::discounts::RecalcType::kBasicPrice),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting)))));IF(B(B(fix,.,F(zone)),==,"boryasvo"),CR(boarding=B(B(ride,.,F(price)),.,F(boarding)),destination_waiting=B(B(ride,.,F(price)),.,F(destination_waiting)),distance=B(B(ride,.,F(price)),.,F(distance)),requirements=B(B(ride,.,F(price)),.,F(requirements)),time=B(B(ride,.,F(price)),.,F(time)),transit_waiting=B(B(ride,.,F(price)),.,F(transit_waiting)),waiting=B(B(ride,.,F(price)),.,F(waiting))));SV(DEFAULT_ALPHA,1.000000);SV(DEFAULT_BETA,0.000000);SV(DEFAULT_SURCHARGE,0.000000);SV(orig_surge,B(B(fix,.,F(surge_params)),.,F(value)));SV(alpha,T(B(VA(orig_surge),>=,1.000000),T(U(?,B(B(fix,.,F(surge_params)),.,F(surcharge_alpha))),U(*,B(B(fix,.,F(surge_params)),.,F(surcharge_alpha))),VA(DEFAULT_ALPHA)),VA(DEFAULT_ALPHA)));SV(beta,T(B(VA(orig_surge),>=,1.000000),T(U(?,B(B(fix,.,F(surge_params)),.,F(surcharge_beta))),U(*,B(B(fix,.,F(surge_params)),.,F(surcharge_beta))),VA(DEFAULT_BETA)),VA(DEFAULT_BETA)));SV(surcharge,T(B(VA(orig_surge),>=,1.000000),T(U(?,B(B(fix,.,F(surge_params)),.,F(surcharge))),U(*,B(B(fix,.,F(surge_params)),.,F(surcharge))),VA(DEFAULT_SURCHARGE)),VA(DEFAULT_SURCHARGE)));SV(surge,T(B(VA(orig_surge),>=,1.000000),VA(orig_surge),1.000000));SV(alpha_surge_beta,B(B(VA(alpha),*,VA(surge)),+,VA(beta)));SV(is_cargo_category,B(B("cargo_categories_list",in,B(fix,.,F(exps))),&&,B(B(fix,.,F(category)),in,B(B(fix,.,F(exps)),.,"cargo_categories_list"))));SV(waitings_coeff,T(B(B(B(fix,.,F(country_code2)),==,"RU"),&&,U(!,VA(is_cargo_category))),VA(surge),1.000000));SV(boarding,B(B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(boarding))),+,B(VA(beta),*,VA(surcharge))));SV(distance,B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(distance))));SV(time,B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(time))));SV(requirements,B(VA(alpha_surge_beta),*,B(B(ride,.,F(price)),.,F(requirements))));SV(waiting,B(VA(waitings_coeff),*,B(B(ride,.,F(price)),.,F(waiting))));SV(transit_waiting,B(VA(waitings_coeff),*,B(B(ride,.,F(price)),.,F(transit_waiting))));SV(destination_waiting,B(VA(waitings_coeff),*,B(B(ride,.,F(price)),.,F(destination_waiting))));SV(current_price_without_waiting,B(B(B(B(B(ride,.,F(price)),.,F(boarding)),+,B(B(ride,.,F(price)),.,F(distance))),+,B(B(ride,.,F(price)),.,F(time))),+,B(B(ride,.,F(price)),.,F(requirements))));SV(delta_without_waiting,B(B(B(B(VA(boarding),+,VA(distance)),+,VA(time)),+,VA(requirements)),-,VA(current_price_without_waiting)));IF(B("surge_rounding",in,B(fix,.,F(exps))),SV(surge_rounding_factor,B(FC(getToValueFromExperiment,NT(exp=B(B(fix,.,F(exps)),.,"surge_rounding")),R(metadata=std::unordered_map<std::string,double>,val=double)),.,F(val)));SV(honest_round_delta,B(B(VA(delta_without_waiting),-,B(0.500000,*,VA(surge_rounding_factor))),round_to,VA(surge_rounding_factor)));SV(previous_category,FC(getPreviousCategory,NT(),R(coeff=double,found=bool,metadata=std::unordered_map<std::string,double>,str=std::string)));SV(previous_category_info,FC(getPreviousCategoryInfo,NT(category=B(VA(previous_category),.,F(str))),R(found=bool,max_surge_delta_raw=double,metadata=std::unordered_map<std::string,double>,price_after_surge=double)));SV(price_after_surge_without_waiting,T(B(B(VA(previous_category),.,F(found)),&&,B(VA(previous_category_info),.,F(found))),B(FC(max,NT(a=B(VA(current_price_without_waiting),+,VA(honest_round_delta)),b=B(FC(min,NT(a=B(B(VA(previous_category_info),.,F(price_after_surge)),*,B(VA(previous_category),.,F(coeff))),b=B(VA(current_price_without_waiting),+,B(VA(previous_category_info),.,F(max_surge_delta_raw)))),R(metadata=std::unordered_map<std::string,double>,res=double)),.,F(res))),R(metadata=std::unordered_map<std::string,double>,res=double)),.,F(res)),B(VA(current_price_without_waiting),+,VA(honest_round_delta))));SV(delta,B(VA(price_after_surge_without_waiting),-,VA(current_price_without_waiting)));SV(effective_surge,T(B(VA(price_after_surge_without_waiting),>,B(VA(current_price_without_waiting),+,VA(honest_round_delta))),B(VA(delta),round_to,VA(surge_rounding_factor)),B(VA(delta),round_to,B(fix,.,F(rounding_factor)))));SV(show_surge_params,FC(getShowSurgeOrSurcharge,NT(delta=VA(effective_surge),forced_surcharge=VA(is_cargo_category)),R(metadata=std::unordered_map<std::string,double>,show_surcharge=bool,show_surge=bool,val=double)));SV(meta1,T(B(B(VA(show_surge_params),.,F(show_surge)),!=,B(VA(show_surge_params),.,F(show_surcharge))),T(B(VA(show_surge_params),.,F(show_surge)),MAP("setcar.show_surge"=B(VA(show_surge_params),.,F(val))),MAP("setcar.show_surcharge"=B(VA(show_surge_params),.,F(val)))),MAP()));SV(surge_delta_raw,B(B(B(B(B(VA(current_price_without_waiting),+,VA(effective_surge)),+,VA(waiting)),+,VA(transit_waiting)),+,VA(destination_waiting)),-,U(*,B(ride,.,F(price)))));SV(meta2,MAP("surge_delta_raw"=VA(surge_delta_raw),"surge_delta"=B(VA(surge_delta_raw),round_to,B(fix,.,F(rounding_factor))),"max_surge_delta_raw"=B(FC(max,NT(a=B(VA(previous_category_info),.,F(max_surge_delta_raw)),b=VA(surge_delta_raw)),R(metadata=std::unordered_map<std::string,double>,res=double)),.,F(res)),"price_after_surge"=B(VA(surge_delta_raw),+,U(*,B(ride,.,F(price))))));CR(boarding=B(B(B(ride,.,F(price)),.,F(boarding)),+,VA(effective_surge)),destination_waiting=VA(destination_waiting),metadata=B(VA(meta1),+,VA(meta2)),transit_waiting=VA(transit_waiting),waiting=VA(waiting)));SV(show_surge_params,FC(getShowSurgeOrSurcharge,NT(delta=VA(delta_without_waiting),forced_surcharge=VA(is_cargo_category)),R(metadata=std::unordered_map<std::string,double>,show_surcharge=bool,show_surge=bool,val=double)));SV(meta1,T(B(B(VA(show_surge_params),.,F(show_surge)),!=,B(VA(show_surge_params),.,F(show_surcharge))),T(B(VA(show_surge_params),.,F(show_surge)),MAP("setcar.show_surge"=B(VA(show_surge_params),.,F(val))),MAP("setcar.show_surcharge"=B(VA(show_surge_params),.,F(val)))),MAP()));SV(surge_delta_raw,B(B(B(B(B(B(B(VA(boarding),+,VA(distance)),+,VA(time)),+,VA(requirements)),+,VA(waiting)),+,VA(transit_waiting)),+,VA(destination_waiting)),-,U(*,B(ride,.,F(price)))));SV(meta2,MAP("surge_delta_raw"=VA(surge_delta_raw),"surge_delta"=B(VA(surge_delta_raw),round_to,B(fix,.,F(rounding_factor))),"max_surge_delta_raw"=VA(surge_delta_raw),"price_after_surge"=B(VA(surge_delta_raw),+,U(*,B(ride,.,F(price))))));CR(boarding=VA(boarding),destination_waiting=VA(destination_waiting),distance=VA(distance),metadata=B(VA(meta1),+,VA(meta2)),requirements=VA(requirements),time=VA(time),transit_waiting=VA(transit_waiting),waiting=VA(waiting))
