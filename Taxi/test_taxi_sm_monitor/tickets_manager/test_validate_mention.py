import pytest

from taxi_sm_monitor.api import youscan


@pytest.mark.config(YOUSCAN_TO_STARTRACK_ENABLED=True)
@pytest.mark.parametrize(
    'data',
    (
        # –ü–æ—Å—Ç
        {
            'author': {
                'avatarUrl': 'https://userapi.com/PSplRx50_7I.jpg?ava=1',
                'name': '–¢–∞–∫—Å–æ–ø–∞—Ä–∫ –†–í–ö',
                'nickname': 'taxoparkrbk',
                'subscribers': 1205,
                'url': 'http://vk.com/club185605318',
            },
            'channel': {
                'avatarUrl': 'https://userapi.com/PSplRx50_7I.jpg?ava=1',
                'name': '–¢–∞–∫—Å–æ–ø–∞—Ä–∫ –†–í–ö',
                'nickname': 'taxoparkrbk',
                'subscribers': 1205,
                'url': 'http://vk.com/club185605318',
            },
            'comments': 0,
            'country': 'ru',
            'discussionId': '-185605318_50',
            'engagement': 0,
            'imageUrl': 'https://userapi.com//a657/SOIK8ZU-fHg.jpg',
            'language': 'rus',
            'likes': 0,
            'mentionId': 42095240,
            'postId': '-185605318_50',
            'postType': 'post',
            'published': '2019-10-14T20:57:19Z',
            'reposts': 0,
            'resourceType': 'social',
            'sentiment': 'neutral',
            'sourceName': 'vk.com',
            'spam': False,
            'text': '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ <b>–≤–æ–¥–∏—Ç–µ–ª–µ–π</b> –∫ <b>—Ç–∞–∫—Å–æ–º–µ—Ç—Ä—É</b> —Å–µ—Ä–≤–∏—Å–∞',
            'themeId': 83499,
            'themeName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'taxi',
            'url': 'https://vk.com/wall-185605318_50',
        },
        # –†–µ–ø–æ—Å—Ç
        {
            'author': {
                'avatarUrl': 'https://userapi.com/1E9_2MhghRk.jpg?ava=1',
                'name': '–ù–µ –¥–æ—Ä–æ–≥–∞—è –æ–±—É–≤—å, –°–ü–±- –õ–µ–Ω—Å–æ–≤–µ—Ç–æ–≤—Å–∫–∏–π',
                'subscribers': 740,
                'url': 'http://vk.com/club112889249',
            },
            'channel': {
                'avatarUrl': 'https://userapi.com/75163/1E9_2MhghRk.jpg?ava=1',
                'name': '–ù–µ –¥–æ—Ä–æ–≥–∞—è –æ–±—É–≤—å, –°–ü–±- –õ–µ–Ω—Å–æ–≤–µ—Ç–æ–≤—Å–∫–∏–π',
                'subscribers': 740,
                'url': 'http://vk.com/club112889249',
            },
            'city': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
            'comments': 0,
            'country': 'ru',
            'discussionId': '-112889249_6790',
            'engagement': 0,
            'imageUrl': 'https://userapi.com/1ea755/R7qM7ZIVISc.jpg',
            'language': 'rus',
            'likes': 0,
            'mentionId': 10486558,
            'parentPostId': '-31639826_20263',
            'postId': '-112889249_6790',
            'postType': 'repost',
            'published': '2019-10-14T20:52:57Z',
            'region': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
            'reposts': 0,
            'resourceType': 'social',
            'sentiment': 'neutral',
            'sourceName': 'vk.com',
            'spam': False,
            'text': '–üp–∏–≥–ªa—à–∞–µ–º o—Ç–≤e—Çc—Ç–≤–µ–Ω–Ω—ãx –≤–æ–¥–∏—Çe–ª–µ–π –¥–ª—è pa–±–æ—Ç—ã –≤ —Ç–∞–∫—Å–∏.üöï',
            'themeId': 83499,
            'themeName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'taxi',
            'url': 'https://vk.com/wall-112889249_6790',
        },
        # –î–æ–ø–æ–ª–Ω–µ–Ω—ã–π —Ä–µ–ø–æ—Å—Ç
        {
            'author': {
                'avatarUrl': 'https://userapi.com/UWQXkmXQWfE.jpg?ava=1',
                'name': '–ú–∏—Ö–∞–∏–ª –Ø–Ω—Ç–∞—Ä–Ω—ã–π',
                'nickname': 'mishan1',
                'subscribers': 390,
                'url': 'http://vk.com/id548966252',
            },
            'channel': {
                'avatarUrl': 'https://userapi.com/UWQXkmXQWfE.jpg?ava=1',
                'name': '–ú–∏—Ö–∞–∏–ª –Ø–Ω—Ç–∞—Ä–Ω—ã–π',
                'nickname': 'mishan1',
                'subscribers': 390,
                'url': 'http://vk.com/id548966252',
            },
            'city': '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥',
            'comments': 0,
            'country': 'ru',
            'discussionId': '548966252_117',
            'engagement': 1,
            'imageUrl': 'https://userapi.com/tl0Ws4Pilyw.jpg',
            'language': 'rus',
            'likes': 1,
            'mentionId': 3500374732,
            'parentPostId': '-183877134_55',
            'postId': '548966252_117',
            'postType': 'extendedRepost',
            'published': '2019-10-14T18:26:49Z',
            'region': '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'reposts': 0,
            'resourceType': 'social',
            'sentiment': 'neutral',
            'sourceName': 'vk.com',
            'spam': False,
            'text': '–°—Ç–∞–≤–∏–º ‚ù§Ô∏è, –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –º–æ–π YouTube –∫–∞–Ω–∞–ª',
            'themeId': 83499,
            'themeName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'taxi',
            'url': 'https://vk.com/wall548966252_117',
        },
        # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        {
            'author': {
                'avatarUrl': 'https://userapi.com/fpcuYGNuCOM.jpg?ava=1',
                'name': '–ù–∞—Ç–∞–ª—å—è –ö–æ–ø—ã–ª–æ–≤–∞',
                'subscribers': 529,
                'url': 'http://vk.com/id232262635',
            },
            'channel': {
                'avatarUrl': 'https://userapi.com/b7RK-kzR7VM.jpg?ava=1',
                'name': '–ü–ª–æ—Ö–∞—è –ü–æ–∫—É–ø–∫–∞ | –ì–æ—Ä–æ–¥ –û—Ä–µ–ª',
                'nickname': 'bad_57',
                'subscribers': 60034,
                'url': 'http://vk.com/club86168582',
            },
            'city': '–û—Ä—ë–ª',
            'country': 'ru',
            'discussionId': '-86168582_839156',
            'engagement': 0,
            'language': 'rus',
            'likes': 0,
            'mentionId': 1314691101,
            'parentPostId': '-86168582_839156',
            'postId': '-86168582_839238',
            'postType': 'comment',
            'published': '2019-10-14T20:59:41Z',
            'region': '–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'resourceType': 'social',
            'sentiment': 'neutral',
            'sourceName': 'vk.com',
            'spam': False,
            'text': '–ù–µ –∑–Ω–∞—é, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–ª—å–∑—É—é—Å—å —ç—Ç–∏–º —Ç–∞–∫—Å–∏',
            'themeId': 83499,
            'themeName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'title': '<b>–Ø–Ω–¥–µ–∫—Å</b> <b>—Ç–∞–∫—Å–∏</b>. <b>–í–æ–¥–∏—Ç–µ–ª—å</b> –æ—Ç–∫–∞–∑–∞–ª—Å—è',
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'taxi',
            'url': 'https://vk.com/wall-86168582_839156?reply=839238',
        },
        # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ–ø–ª–∞—é
        {
            'city': '–û—Ä—ë–ª',
            'country': 'ru',
            'discussionId': '-86168582_839156',
            'engagement': 0,
            'language': 'rus',
            'likes': 0,
            'mentionId': 1314691101,
            'parentPostId': '-86168582_839156',
            'postId': '-86168582_839238',
            'postType': 'replyComment',
            'published': '2019-10-14T20:59:41Z',
            'region': '–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'resourceType': 'social',
            'sentiment': 'neutral',
            'sourceName': 'vk.com',
            'spam': False,
            'text': '–ù–µ –∑–Ω–∞—é, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–ª—å–∑—É—é—Å—å —ç—Ç–∏–º —Ç–∞–∫—Å–∏',
            'themeId': 83499,
            'themeName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'title': '<b>–Ø–Ω–¥–µ–∫—Å</b> <b>—Ç–∞–∫—Å–∏</b>. <b>–í–æ–¥–∏—Ç–µ–ª—å</b> –æ—Ç–∫–∞–∑–∞–ª—Å—è',
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'taxi',
            'url': 'https://vk.com/wall-86168582_839156?reply=839238',
        },
    ),
)
async def test_validate_mention_success(taxi_sm_monitor_app_stq, data: dict):
    assert taxi_sm_monitor_app_stq.ticket_manager.validate_mention(data)


@pytest.mark.parametrize(
    'data',
    (
        {},
        {
            'mentionId': 42095240,
            'published': '2019-10-14T20:57:19Z',
            'resourceType': 'social',
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'taxi',
            'url': 'https://vk.com/wall-185605318_50',
        },
        {
            'mentionId': 42095240,
            'postType': 'post',
            'published': 'undefined',
            'resourceType': 'social',
            'spam': False,
            'topicId': 83499,
            'topicName': 'Yandex.Taxi –í–æ–¥–∏—Ç–µ–ª–∏',
            'topicGroup': 'eats',
            'url': 'https://vk.com/wall-185605318_50',
        },
    ),
)
async def test_validate_mention_error(taxi_sm_monitor_app_stq, data: dict):
    with pytest.raises(youscan.MentionValidationError):
        taxi_sm_monitor_app_stq.ticket_manager.validate_mention(data)
