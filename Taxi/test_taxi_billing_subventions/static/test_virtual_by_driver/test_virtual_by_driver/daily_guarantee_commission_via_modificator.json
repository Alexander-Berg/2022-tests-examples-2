{
  "accounts": [
    {
      "account": {
        "account_id": 123004,
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "currency": "XXX",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "num_orders"
      },
      "balances": [
        {
          "accrued_at": "2019-09-18T00:00:00.000000+03:00",
          "balance": "15",
          "last_created": "2019-09-17T23:59:00.000000+00:00",
          "last_entry_id": 34602004
        },
        {
          "accrued_at": "2019-09-17T00:00:00.000000+03:00",
          "balance": "5",
          "last_created": "2019-09-16T23:59:00.000000+00:00",
          "last_entry_id": 34601004
        }
      ]
    },
    {
      "account": {
        "account_id": 123005,
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "currency": "RUB",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "income"
      },
      "balances": [
        {
          "accrued_at": "2019-09-18T00:00:00.000000+03:00",
          "balance": "1000",
          "last_created": "2019-09-17T23:59:00.000000+00:00",
          "last_entry_id": 34602004
        },
        {
          "accrued_at": "2019-09-17T00:00:00.000000+03:00",
          "balance": "0",
          "last_created": "2019-09-16T23:59:00.000000+00:00",
          "last_entry_id": 34601004
        }
      ]
    },
    {
      "account": {
        "account_id": 123006,
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "currency": "RUB",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "num_orders_per_workshift"
      },
      "balances": [
        {
          "accrued_at": "2019-09-18T00:00:00.000000+03:00",
          "balance": "3",
          "last_created": "2019-09-17T23:59:00.000000+00:00",
          "last_entry_id": 34602004
        },
        {
          "accrued_at": "2019-09-17T00:00:00.000000+03:00",
          "balance": "0",
          "last_created": "2019-09-16T23:59:00.000000+00:00",
          "last_entry_id": 34601004
        }
      ]
    },
    {
      "account": {
        "account_id": 123007,
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "currency": "RUB",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "promocode_commission"
      },
      "balances": [
        {
          "accrued_at": "2019-09-18T00:00:00.000000+03:00",
          "balance": "2",
          "last_created": "2019-09-17T23:59:00.000000+00:00",
          "last_entry_id": 34602004
        },
        {
          "accrued_at": "2019-09-17T00:00:00.000000+03:00",
          "balance": "0",
          "last_created": "2019-09-16T23:59:00.000000+00:00",
          "last_entry_id": 34601004
        }
      ]
    },
    {
      "account": {
        "account_id": 123008,
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "currency": "RUB",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "num_orders_per_promocode"
      },
      "balances": [
        {
          "accrued_at": "2019-09-18T00:00:00.000000+03:00",
          "balance": "2",
          "last_created": "2019-09-17T23:59:00.000000+00:00",
          "last_entry_id": 34602004
        },
        {
          "accrued_at": "2019-09-17T00:00:00.000000+03:00",
          "balance": "0",
          "last_created": "2019-09-16T23:59:00.000000+00:00",
          "last_entry_id": 34601004
        }
      ]
    }
  ],
  "expected_balances_request": {
    "accounts": [
      {
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "income"
      },
      {
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "num_orders"
      },
      {
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "num_orders_per_workshift"
      },
      {
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "promocode_commission"
      },
      {
        "agreement_id": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "entity_external_id": "unique_driver_id/0123456789abcdef00000001",
        "sub_account": "num_orders_per_promocode"
      }
    ],
    "accrued_at": [
      "2019-09-17T00:00:00.000000+03:00",
      "2019-09-18T00:00:00.000000+03:00"
    ]
  },
  "expected_docs": {
    "docs": {
      "taxi/shift_ended/taximeter_driver_id/quas/wex": [],
      "taxi/shift_ended/unique_driver_id/0123456789abcdef00000001": [
        {
          "created": "2019-09-17T10:00:00.000000+03:00",
          "data": {
            "agreement_ref": "subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
            "antifraud_rule": {
              "days_span": 1,
              "kind": "daily_guarantee",
              "last_shift_date": "2019-09-17"
            },
            "commission_input": {
              "billing_type": "normal_billing_type",
              "cost_for_commission": "0 RUB",
              "cost_for_rebate": "0 RUB",
              "currency": "RUB",
              "driver_promocode_min_commission": "1 RUB",
              "due": "2019-09-17T00:00:00+03:00",
              "extra_commission": "0 RUB",
              "hired_at": null,
              "hiring_type": null,
              "ind_bel_nds_rate": null,
              "marketing_level": [],
              "park_corp_vat": "1",
              "park_ride_sum": "0 RUB",
              "payment_type": "cash",
              "rebate_rate": "0",
              "source": null,
              "with_driver_promocode": false,
              "with_driver_workshift": false
            },
            "last_date": "2019-09-17",
            "pay_after": "2019-09-18T001:00:00+03:00",
            "pay_to": {
              "external_id": "taximeter_driver_id/some_db_id/some_uuid",
              "kind": "driver"
            },
            "payment_id": "2019-09-17",
            "possible_frauder": null,
            "rule_data": {
              "data": {
                "currency": "RUB",
                "group_id": "MSK_GRNT_GROUP_ID_WITH_COMMISSION",
                "has_commission": true,
                "is_net": false,
                "steps": [
                  {
                    "guarantee_amount": "2000",
                    "id": "123456789012345678901234",
                    "num_orders": 10
                  }
                ],
                "zone_name": "moscow"
              },
              "subvention_type": "nmfg"
            },
            "use_stats_of": {
              "external_id": "unique_driver_id/0123456789abcdef00000001",
              "kind": "driver"
            }
          },
          "doc_id": 1234567890,
          "event_at": "2019-09-17T00:00:00.000000+03:00",
          "external_event_ref": "some_external_event_ref",
          "external_obj_id": "taxi/shift_ended/subvention_agreement/1/default/group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION/unique_driver_id/0123456789abcdef00000001/2019-09-10",
          "kind": "shift_ended",
          "process_at": "2019-09-17T10:00:00.000000+03:00",
          "reason": "reason",
          "service": "some-service",
          "status": "new"
        }
      ]
    }
  },
  "expected_docs_requests": {
    "event_at_begin": "2019-09-17T13:48:50.000000+00:00",
    "event_at_end": "2019-12-16T13:48:50.000000+00:00",
    "tags": [
      "taxi/shift_ended/unique_driver_id/0123456789abcdef00000001",
      "taxi/shift_ended/taximeter_driver_id/quas/wex"
    ]
  },
  "expected_result": {
    "subventions": [
      {
        "commission_info": {
          "payoff_commission": {
            "amount": "61.000",
            "currency": "RUB"
          }
        },
        "payoff": {
          "amount": "1000",
          "currency": "RUB"
        },
        "period": {
          "end_time": "2019-09-18T00:00:00+03:00",
          "start_time": "2019-09-17T00:00:00+03:00"
        },
        "subvention_rule_id": "group_id/MSK_GRNT_GROUP_ID_WITH_COMMISSION",
        "type": "nmfg"
      }
    ]
  },
  "query": {
    "driver": {
      "db_id": "quas",
      "uuid": "wex"
    }
  }
}
