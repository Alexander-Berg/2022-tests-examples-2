settings:
    collection: subventions
    connection: billing
    database: dbbilling
indexes:
  - key:
      - name: a
        type: ascending
      - name: v
        type: descending
    unique: true
  - key:
      - name: c
        type: ascending
      - name: p
        type: ascending
  - key:
      - name: od
        type: ascending
      - name: p
        type: ascending
  - key:
      - name: p
        type: ascending
      - name: od
        type: descending
  - key:
      - name: p
        type: ascending
      - name: od
        type: ascending
    partialFilterExpression:
        ts: no_offer
  - key:
      - name: ts
        type: ascending
      - name: c
        type: ascending
  - key:
      - name: u
        type: ascending
      - name: p
        type: ascending
wiki_info: |
    #### subventions

    *Назначение:* содержит информацию об начислениях и изменениях субсидий
    по заказам.



    *Структура документа*:
    ```python
    {
        # id заказа
        'o': '0123456789abcdef',

        # alias_id заказа
        'a': 'fedcba9876543210',

        # версия, у одного alias_id не может быть одинаковых версий
        # значение 'cv' у документа с наиболее поздней версией - это самое
        # актульное значение субсидии
        'v': 2,

        # время создания документа, naive utc
        'c': datetime.datetime.utcnow(),

        # время изменения документа, naive utc
        # может изменяться только при переходе статуса i -> d
        # (на данный момент не реализовано)
        'u': datetime.datetime.utcnow(),

        # время подачи заказа (request.due), naive utc
        'od': datetime.datetime.utcnow(),

        # тип начисления (s - субсидия)
        't': 's',

        # статус субсидии (i - начислена, d - подтверждена)
        # на данный момент фиксация (подтверждение) субсидий не реализована
        's': 'i',

        # текущее значение субсидии по данному заказу
        'cv': '20.0',

        # текущее значение субсидии в валюте cc_cur
        'cc_cv': '30.0',

        # Внимание: чтобы получить информацию о фактических комиссиях с субсидий, надо выбрать документы с 'ifk' не равным True.
        # Комиссия с субсидии
        'sc': '1.234',

        # Размер компенсированной скидки
        'ds': '3.234',

        # Размер компенсации за пул
        'ps': '3.234',

        # потенциальное значение субсидии
        'fv': '20.0',

        # Если True, то значение еще не определено
        # (в этом случае 'cv' == 0, 'sc' != 0 (если мы берем комиссию с субсидии))
        'ifk': True,

        # статус передачи данных в траст, подробнее в promocode_compensations
        # если 'ts' == 'saved', значит мы оплатили субсидию парку (на баланс водителя
        # эти деньги поступят)
        # если 'ts' == 'no_offer', значит у парка нет оферты, и на баланс водителя
        # эти деньги поступят, но парку мы не заплатили
        # если 'ts' == 'init' - значит у парка есть оферта, но субсидию
        # мы еще не оплатили, но оплатим в ближайшее время.
        'ts': 'init|ignored|...|...|no_city',

        # предыдущее значение субсидии по данному заказу (0, если v = 1)
        'pv': '0',

        # предыдущее значение субсидии по данному заказу в валюте cc_cur (0, если v = 1)
        'cc_pv': '0',

        # валюта начисления субсидии (для отдачи в CSV)
        'cu': 'RUB',

        # клид парка (для отдачи в CSV)
        'p': '1915160',

        # db_id парка (для отдачи в CSV)
        'db_id': 'fdflkj34lkjfhs2kjvcbnxm',

        # город заказа
        'ci': 'Москва',

        # id водителя (для отдачи в CSV)
        'd': 'asdflkjhryewuio',

        # комментарий с причиной изменения субсидии (для отдачи в CSV)
        'co': '',

        # Причина изменения субсидии (для внутреннего использования)
        # если субсидия начислена в процессе миграции, то здесь должно быть
        # значение "migration". Причины, проставляемые автоматически,
        # можно найти в коде.
        'r': 'migration',

        # На сколько нужно домножить значение субсидии перед оплатой в парк
        'dms': '1.06',

        # в какой валюте поля cc_*?
        'cc_cur': 'RUB',

        # Курс из cu в cc_cur
        'cc_rate': '56.5',

        # Текущее значение субсидии без комиссии (нет у старых заказов)
        'cvwc': '34.23'

        # Причины снижения субсидии, 'r' может принимать значения {'surge', 'mph'},
        # 'v' - абсолютное значение на которое субсидия была снижена
        'dr': [{'r': 'surge', 'v': '20.5'}],
        # версии документов holded_subventions, которые участвовали в клиринге
        # deprecated
        'clear_of_versions': [1, 2],
        # id документов holded_subventions, которые участвовали в клиринге
        'clear_of_ids': [bson.ObjectId(), bson.Object()]

        # статусы отправки в billing-orders
        'billing_orders_net_status': 'success',
        'billing_orders_send_all_status': 'success',
        'billing_orders_status': 'success',
    }
    ```
