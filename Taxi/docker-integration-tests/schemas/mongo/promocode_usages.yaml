description: promocodes registered usages (unique and non-unique)
settings:
    collection: promocode_usages
    connection: taxi
    database: dbtaxi
indexes:
  - key: card_id
    sparse: true
  - key: code
    sparse: true
  - key: code_hash
    sparse: true
  - key: device_id
    sparse: true
  - key: phone_id
  - key: reserve
  - key: series_id
  - key: updated
wiki_info: |
    ####dbtaxi.promocode_usages - использование промокодов

    "Новая" промокодная коллекция, используется с версии 1.8.61. В более ранних версиях информация, хранящаяся в этой коллекции, была встроена в dbtaxi.coupons.
    Документ в этой коллекции создается при резервировании промокода на заказ и удаляется при освобождении промокода.

    ```python
    dbtaxi.promocode_usages = {
        # Обязательные поля
        '_id': ObjectId(),       # Генерируется Mongo, нами не используется.
        'series_id': 'строка',    # Серия, к которой принадлежит использованный промокод.
        'phone_id': ObjectId(),   # Идентификатор телефона пользователя, применившего промокод.
        'reserve': ObjectId(),    # Идентификатор заказа, на который зарезервирован промокод.
        'value': 300,             # Сумма скидки по промокоду.
        'updated': datetime.datetime.now() # Дата обновления документа
        'type': 'single' #тип промокода single|multi
        # Необязательные поля
        # Имеется у использованных уникальных промокодов в зависимости от promocode_series.clear_text
        'code': 'prm123456',      # Уникальный промокод, promocode_series.clear_text=True
        'code_hash': 'строка',    # Хэш уникальной части использованного промокода. promocode_series.clear_text!=True


        # Не используются, начиная с версии 1.10.35
        'card_id': 'строка',      # persistent_id кредитной карты, использованной для оплаты поездки по промокоду. Если отсутвует или None, карта неезвестна или заказ был за наличные.
        'device_id': 'строка',    # Идентификатор устройства, с которого был сделан заказ. Если отсутствует или None, устройство неизвестно.
    }
    ```
    ####dbtaxi.promocode_usages2 - использование промокодов по пользователю

    Коллекция, которая со временем должна заменить promocode_usages.
    Документ в этой коллекции хранит все использования конкретного промокода пользователем.

    ```python
    dbtaxi.promocode_usages = {
        # Обязательные поля
        '_id': ObjectId(),              # Генерируется Mongo, нами не используется.
        'series_id': 'asdf',            # Серия, к которой принадлежит использованный промокод.
        'code': '123456',               # Код промокода для уникальных промокодов.
        'phone_id': ObjectId(),         # Идентификатор телефона пользователя, применившего промокод.
        'value': 200,                   # Величина промокода.
        'cost_usage': 150,              # На какую общую сумму был использован промокод пользователем.
        'rides': 1,                     # Количество поездок ползователя по этому промокоду.
        'usages': [                     # Список использований промокодов.
            {
                'reserve': 'order_id',  # Идентификатор заказа, на который зарезервирован промокод.
                'cost_usage': 150,      # На какую сумму был использван промокод этим заказом.
            },
            ...
        ],
    }
    ```
