description: user discounts
settings:
    collection: user_discounts
    connection: taxi
    database: dbtaxi
indexes:
  - key: confirmation_id
    sparse: true
    unique: true
  - key: discounts.id
    sparse: true
    unique: true
  - key:
      - name: zone_name
        type: ascending
      - name: zone_type
        type: ascending
    unique: true
wiki_info: |
    #### dbtaxi.user_discounts - Пользовательские скидки на заказ

    Содержит правила предоставления скидок пользователю на заказы. Смотри в описании админки раздел [Управление пользовательскими скидками](https://wiki.yandex-team.ru/taxi/backend/api/admin/#upravleniepolzovatelskimiskidkami).
    Каждый документ описывает список правил для конкретной зоны

    Структура документа:
    ```json
    {
        // Deprecated зона предоставления скидки
        // Deprecated "_id": "spb",
        // название зоны предоставления скидки
        "zone_name": "spb",
        // тип зоны предоставления скидки
        "zone_type": "tariff_zone", // возможны "tariff_zone" или "agglomeration"
        // включены ли скидки в этой зоне
        "enabled": true,  // или false
        // тело скидки
        "discounts": [ <...> ],  // можно []
        // тикет, по которому заводилась скидка
        "ticket": "TAXIRATE-123"  // заапрувленный тикет из стартрека
        // номер версии, необходимо во избежание условия гонки, когда одну скидку редактируют одновременно два человека либо в двух вкладках. последний полученный version фронтэенд отправляет на бэкенд, и в случае их несовпадения не даёт сохранить скидку
        "version": 15,
        // ID отложенного запуска из коллекции admin_confirmations для возможности отложенного запуска с подтверждением
        "confirmation_id": "5ce7afe5d674488588fa92a7d2017c72"
    }
    ```

    Тело скидки (один элемент из поля discounts) выглядит так

    | Имя| Тип| Ограничения| Описание|
    |----|----|------------|---------|
    | `classes`| массив строк| Пример: ["econom", "comfort"]| Для каких тарифов действует скидка|
    | `current_method`| строка| варианты: "time-dist", "full", "full-driver-less"| Метод вычисления скидки. **time-dist** -- скидка не меньше минималки; **full** -- полная скидка; **full-driver-less** -- полная скидка с ограничениями по выплатам|
    | `enabled`| boolean| true/false| Включена ли скидка|
    | `final_max_value`| число| [0, 1)| Максимальное значение скидки после рандомизации (0 - нет скидки, 1 - 100%)|
    | `final_min_value`| число| [0, 1)| Минимальное значение скидки после рандомизации (0 - нет скидки, 1 - 100%)|
    | `for`| строка| варианты: "all", "newbie", "big_first", "surge", "selected"| Для кого предназначена скидка: для всех, для новичков, первая большая скидка, сурж. selected — скидка для пользователей, которых выбрали аналитики|
    | `formula_v1_a1`| число| | A1 (параметр формулы)|
    | `formula_v1_a2`| число| | A2 (параметр формулы)|
    | `formula_v1_c1`| число| | C1 (параметр формулы)|
    | `formula_v1_c2`| число| | C2 (параметр формулы)|
    | `formula_v1_p1`| число| | P1 (параметр формулы)|
    | `formula_v1_p2`| число| | P2 (параметр формулы)|
    | `formula_v1_threshold`| число| | Граница между первой и второй формулой |
    | `geoarea`| строка| | Геозона, на которую применяется скидка (необязательный параметр)|
    | `geoarea_a` | строка| | Геозона по точке А, на которую применяется скидка (необязательный параметр)|
    | `geoarea_b` | строка| | Геозона по точке Б, на которую применяется скидка (необязательный параметр)|
    | `max_value`| число| [0, 1)| Максимальное значение скидки (0 - нет скидки, 1 - 100%)|
    | `min_value`| число| [0, 1)| Минимальное значение скидки (0 - нет скидки, 1 - 100%) |
    | `newbie_max_coeff`| число| >=0| Максимальная надбавка к величине скидки для новичка|
    | `newbie_num_coeff`| число| >=0| Коэффициент, который изменяет влияние количества поездок новичка на величину скидки |
    | `num_rides_for_newbies`| число| >=0| Число поездок для новичков|
    | `payment_types`| массив строк| любое сочетание строк без повторений из "card", "applepay", "cash", "corp"| Допустимый тип оплаты для применения скидки. Пример: ["card", "applepay"]|
    | `random_p`| число| [0, 1)| Вероятность случайной скидки P|
    | `random_s`| число| [0, 1)| Размер случайной скидки S|
    | `random_time_threshold`| число| >=1| На сколько минут выравнивать случайную скидку|
    | `round_digits`| число| [0, 20)| До скольки знаков после запятой округлять скидку: round(0.135, 2) = 0.14 = 14%|
    | `selected_user_tags`| массив строк | | С какими тегами применять скидку по списку пользователей|
    | `disable_by_surge`| число| >=0 либо None| Скидка не применяется, если точка А находится в зоне с суржом > N. None - отключить такую функциональность|
    | `date_from`| datetime| формат `"%Y-%m-%dT%H:%M:%S%z"`| Дата начала действия скидки|
    | `date_to`| datetime| формат `"%Y-%m-%dT%H:%M:%S%z"`| Дата, до которой действует скидка|
    | `dt` | целое число| 0 скидка применяется по рабочим дням, 1 - по выходным, 2 - ежедневно| Дни недели, в которые действует скидка|
    | `hours`| массив словарей| каждый словарь содержит два ключа "from_time" и "to_time", значения - время в формате `"HH:MM"`| Временные промежутки, когда работает скидка|
    | `apply_randomly`| boolean| true/false| Применяется ли скидка случайным образом|
    | `is_cashback`| boolean| true/false| Считать ли скидку через флоу кешбека (необязательный параметр, если отсутствует - считается false)|
    | `discount_cache_ttl`| целое число| >0| Время кэширования результата случайного розыгрыша скидки|
    | `random_probability`| число| [0, 1)| Вероятность выпадения случайной скидки|
    | `use_user_id`| boolean| true/false| Учитывать ли user_id при кэшировании случайной скидки|
    | `count_daily_budget`| boolean| true/false| Учитывать суточный бюджет скидки|
    | `daily_budget`| число| >=0| Суточный бюджет скидки в валюте зоны|
    | `bin_filter`| массив чисел| | Список бинов карт, для которых работает скидка |
    | `description` | строка | | Необязательный тег описания скидки. Пример: `"description":"moscow_all_10"` |
