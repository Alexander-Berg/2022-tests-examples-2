{
  "cities": {
    "Москва": {
      "country_code": "rus",
      "donate_multipliers": {
        "default": "1.2"
      }
    }
  },
  "currency_rates": {
    "RUBUSD": {
      "2021-06-10": "0.1"
    }
  },
  "expected_docs": [
    {
      "data": {
        "agreement": {
          "ref": "subvention/counter/counter",
          "rule_data": {
            "counter": "counter",
            "currency": "RUB",
            "rule_id": "id1",
            "steps": [
              {
                "amount": "100",
                "nrides": 2
              }
            ],
            "type": "goal"
          }
        },
        "contract": {
          "currency": "USD",
          "id": 1,
          "service_id": 1164,
          "target": "oebs"
        },
        "driver": {
          "billing_client_id": "100500",
          "clid": "643753730233",
          "driver_license_personal_id": "some_driver_license_personal_id",
          "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
          "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
          "unique_driver_id": "5b05621ee6c22ea2654849f4"
        },
        "pay_per_contract": "yes",
        "payment_meta": {
          "budget_id": "budget",
          "city_id": "Москва",
          "country_code": "rus",
          "is_cargo": true,
          "oebs_mvp_id": "MSKc",
          "payment_ref": "f213c6b839ff7cd69b85410dc9caae3b",
          "service_to_contract": {
            "1164": 1
          },
          "subvention_ref": {
            "$md5": "5b05621ee6c22ea2654849f4:counter:1"
          },
          "tariff_class": "econom",
          "tariff_zone": "moscow",
          "time_zone": "Europe/Moscow"
        },
        "shift": {
          "duration_in_days": 2,
          "end": "2021-01-02T03:00:00+03:00",
          "start": "2021-01-01T03:00:00+03:00"
        },
        "version": 1
      },
      "event_at": "2021-01-02T00:00:00+00:00",
      "external_event_ref": "counter/1/1/1",
      "external_obj_id": "taxi/shift/unique_driver_id/5b05621ee6c22ea2654849f4",
      "journal_entries": [],
      "kind": "taxi_goal_shift",
      "process_at": "2021-01-02T04:00:00+00:00",
      "service": "billing-functions",
      "status": "new",
      "tags": [
        "taxi/shift_ended/unique_driver_id/5b05621ee6c22ea2654849f4/2021-01-02/do_x_get_y"
      ]
    },
    {
      "data": {
        "agreement": {
          "ref": "subvention/counter/personal_counter",
          "rule_data": {
            "counter": "personal_counter",
            "currency": "RUB",
            "rule_id": "id_",
            "steps": [
              {
                "amount": "100",
                "nrides": 20
              }
            ],
            "type": "goal"
          }
        },
        "contract": {
          "currency": "USD",
          "id": 1,
          "service_id": 1164,
          "target": "oebs"
        },
        "driver": {
          "billing_client_id": "100500",
          "clid": "643753730233",
          "driver_license_personal_id": "some_driver_license_personal_id",
          "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
          "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
          "unique_driver_id": "5b05621ee6c22ea2654849f4"
        },
        "pay_per_contract": "yes",
        "payment_meta": {
          "budget_id": "deadbeef",
          "city_id": "Москва",
          "country_code": "rus",
          "is_cargo": true,
          "oebs_mvp_id": "MSKc",
          "payment_ref": "920d56887c3308f24ac74805e4ac66cd",
          "service_to_contract": {
            "1164": 1
          },
          "subvention_ref": {
            "$md5": "5b05621ee6c22ea2654849f4:personal_counter:5"
          },
          "tariff_class": "econom",
          "tariff_zone": "moscow",
          "time_zone": "Europe/Moscow"
        },
        "shift": {
          "duration_in_days": 1,
          "end": "2021-01-02T03:00:00+03:00",
          "start": "2021-01-01T03:00:00+03:00"
        },
        "version": 1
      },
      "event_at": "2021-01-02T00:00:00+00:00",
      "external_event_ref": "personal_counter/5/1/1",
      "external_obj_id": "taxi/shift/unique_driver_id/5b05621ee6c22ea2654849f4",
      "journal_entries": [],
      "kind": "taxi_goal_shift",
      "process_at": "2021-01-02T04:00:00+00:00",
      "service": "billing-functions",
      "status": "new",
      "tags": [
        "taxi/shift_ended/unique_driver_id/5b05621ee6c22ea2654849f4/2021-01-02/do_x_get_y"
      ]
    }
  ],
  "expected_open_shift_requests": [
    {
      "agreement_ref": "subvention_agreement/1/default/group_id/group_id",
      "doc_ref": 12345,
      "driver": {
        "clid": "643753730233",
        "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
        "license_personal_id": "some_driver_license_personal_id",
        "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
        "unique_driver_id": "5b05621ee6c22ea2654849f4"
      },
      "order": {
        "completed_by_dispatcher": false,
        "cost": "50",
        "cost_for_subvention": "60",
        "currency": "RUB",
        "due": "2021-06-10T19:00:00+03:00",
        "status": "finished",
        "taxi_status": "complete"
      }
    },
    {
      "agreement_ref": "subvention_agreement/1/default/group_id/group_id_do_x_get_y",
      "doc_ref": 12345,
      "driver": {
        "clid": "643753730233",
        "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
        "license_personal_id": "some_driver_license_personal_id",
        "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
        "unique_driver_id": "5b05621ee6c22ea2654849f4"
      },
      "order_due": "2021-06-10T19:00:00+03:00"
    },
    {
      "agreement_ref": "subvention_agreement/1/personal/group_id/group_id_personal_do_x_get_y",
      "doc_ref": 12345,
      "driver": {
        "clid": "643753730233",
        "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
        "license_personal_id": "some_driver_license_personal_id",
        "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
        "unique_driver_id": "5b05621ee6c22ea2654849f4"
      },
      "order_due": "2021-06-10T19:00:00+03:00"
    }
  ],
  "expected_results": {
    "$Subventions": {
      "antifraud_precheck": {
        "$AntifraudPrecheck": {
          "is_goal_allowed": true,
          "is_single_on_top_allowed": true,
          "is_single_ride_allowed": true
        }
      },
      "is_eligible": true,
      "shifts": [
        {
          "$SubventionShift": {
            "data": {
              "$GoalRuleShift": {
                "contract_id": 1,
                "counter": "counter",
                "kind": "goal",
                "num_orders": 1
              }
            },
            "doc_id": 5000
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$NmfgRuleShift": {
                "commission": "7.3599",
                "income": "50.0000",
                "kind": "nmfg",
                "num_orders": 1,
                "rule_group_id": "group_id",
                "subvention_income": "10.0000"
              }
            },
            "doc_id": 11111
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$DoXGetYShift": {
                "is_personal": false,
                "kind": "do_x_get_y",
                "num_orders": 1,
                "rule_group_id": "group_id_do_x_get_y"
              }
            },
            "doc_id": 22222
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$DoXGetYShift": {
                "is_personal": true,
                "kind": "do_x_get_y",
                "num_orders": 1,
                "rule_group_id": "group_id_personal_do_x_get_y"
              }
            },
            "doc_id": 33333
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$GeoBookingRuleShift": {
                "income": "50.0000",
                "kind": "geo_booking",
                "rule_id": "6007f71ac613e38b8bf9cdc3",
                "subvention_income": "10.0000"
              }
            },
            "no_doc_reason": "zero_time_on_order"
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$GoalRuleShift": {
                "contract_id": 1,
                "counter": "personal_counter",
                "kind": "goal",
                "num_orders": 1
              }
            },
            "doc_id": 5001
          }
        }
      ]
    }
  },
  "expected_stq_calls": [
    {
      "args": [
        5000
      ],
      "eta": "2021-01-02T04:00:00.000000Z",
      "kwargs": {},
      "task_id": "doc_id/5000"
    },
    {
      "args": [
        5001
      ],
      "eta": "2021-01-02T04:00:00.000000Z",
      "kwargs": {},
      "task_id": "doc_id/5001"
    }
  ],
  "query": {
    "$Query": {
      "acquiring_commission_agreement_rate": {
        "$decimal": "0.02"
      },
      "call_center_surcharge_inc_vat": {
        "$decimal": "0"
      },
      "commissions": [
        {
          "$Commission": {
            "group": {
              "$commission_group": "base"
            },
            "value": {
              "$decimal": "6.1333"
            },
            "vat": {
              "$decimal": "1.2266"
            }
          }
        }
      ],
      "contracts": [
        {
          "$Contract": {
            "currency": "USD",
            "firm_id": null,
            "id": 1,
            "target": "oebs"
          }
        }
      ],
      "doc_ref": 12345,
      "driver": {
        "$Driver": {
          "activity_points": 81,
          "available_tariff_classes": [
            "econom"
          ],
          "billing_client_id": "100500",
          "clid": "643753730233",
          "driver_license_personal_id": "some_driver_license_personal_id",
          "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
          "hired_at": null,
          "hiring_type": null,
          "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
          "profile_payment_type_restrictions": "none",
          "tariff_zone": "kursk",
          "unique_driver_id": "5b05621ee6c22ea2654849f4"
        }
      },
      "goal_precheck_enabled": false,
      "multiply_instant_payments_by_counter": false,
      "netting_config": {
        "$netting_config": {}
      },
      "order": {
        "$Order": {
          "accepted_by_driver_at": {
            "$datetime": "2021-06-10T19:00:00+03:00"
          },
          "cancel_distance": null,
          "cancelled_at": null,
          "cancelled_with_captcha": null,
          "city_id": "Москва",
          "closed_without_accept": false,
          "commission_limit_if_promocode": {
            "$decimal": "1"
          },
          "completed_at": {
            "$datetime": "2021-06-10T20:00:00+03:00"
          },
          "cost": {
            "$decimal": "50"
          },
          "cost_for_driver": null,
          "counter_multiplier": 1,
          "country_code": "rus",
          "currency": "RUB",
          "discount": {
            "$decimal": "10"
          },
          "driver_with_promocode": false,
          "driver_with_workshift": false,
          "due": {
            "$datetime": "2021-06-10T19:00:00+03:00"
          },
          "id": "<order_id>",
          "ind_bel_nds_rate": null,
          "is_cargo": true,
          "marketing_level": {
            "$frozenset": []
          },
          "need_dispatcher_acceptance": false,
          "oebs_mvp_id": "MSKc",
          "park_corp_vat": null,
          "park_ride_sum": {
            "$decimal": 100
          },
          "payment_type": {
            "$payment_type": "card"
          },
          "rebate_rate": null,
          "source": null,
          "status": "finished",
          "tariff_class": "econom",
          "tariff_zone": "moscow",
          "taxi_status": "complete",
          "time_zone": "Europe/Moscow",
          "transporting_distance_meters": 10,
          "transporting_time_seconds": 32
        }
      },
      "rules": [
        {
          "$GoalRule": {
            "budget_id": "budget",
            "counter": "counter",
            "currency": "RUB",
            "id": "id1",
            "is_personal": false,
            "steps": [
              {
                "$GoalRuleStep": {
                  "amount": {
                    "$decimal": "100"
                  },
                  "nrides": 2
                }
              }
            ],
            "window": {
              "$GoalRuleWindow": {
                "end": {
                  "$datetime": "2021-01-02T00:00:00+00:00"
                },
                "number": 1,
                "size": 2,
                "start": {
                  "$datetime": "2021-01-01T00:00:00+00:00"
                }
              }
            }
          }
        },
        {
          "$NmfgRule": {
            "activity_points": null,
            "budget_id": "budget",
            "group_id": "group_id",
            "id": "id1",
            "is_net": true
          }
        },
        {
          "$DoXGetYRule": {
            "activity_points": null,
            "group_id": "group_id_do_x_get_y",
            "id": "id_do_x_get_y",
            "is_personal": false
          }
        },
        {
          "$DoXGetYRule": {
            "activity_points": null,
            "group_id": "group_id_personal_do_x_get_y",
            "id": "id_personal_do_x_get_y",
            "is_personal": true
          }
        },
        {
          "$GeoBookingRule": {
            "activity_points": 40.0,
            "budget_id": "d2e6b042-355d-4223-b025-47762d6d4a36",
            "end": {
              "$datetime": "2021-12-01T21:00:00+00:00"
            },
            "id": "6007f71ac613e38b8bf9cdc3",
            "is_relaxed_income_matching": true,
            "is_relaxed_order_time_matching": false,
            "local_days_of_week": [
              {
                "$iso_week_day": 5
              }
            ],
            "min_online_minutes": 30,
            "profile_payment_type_rule": {
              "$profile_payment_type_rule": "any"
            },
            "rate_free_per_minute": {
              "$decimal": "10"
            },
            "rate_on_order_per_minute": {
              "$decimal": "17"
            },
            "rule_type": "guarantee",
            "start": {
              "$datetime": "2021-01-20T21:00:00+00:00"
            },
            "tariff_classes": [
              "econom"
            ],
            "tariff_zone": "moscow",
            "workshift_duration": {
              "$timedelta": {
                "seconds": 32400
              }
            },
            "workshift_start": {
              "$time": "11:00"
            }
          }
        },
        {
          "$GoalRule": {
            "budget_id": "deadbeef",
            "counter": "personal_counter",
            "currency": "RUB",
            "id": "id_",
            "is_personal": true,
            "steps": [
              {
                "$GoalRuleStep": {
                  "amount": {
                    "$decimal": "100"
                  },
                  "nrides": 20
                }
              }
            ],
            "window": {
              "$GoalRuleWindow": {
                "end": {
                  "$datetime": "2021-01-02T00:00:00+00:00"
                },
                "number": 5,
                "size": 1,
                "start": {
                  "$datetime": "2021-01-01T00:00:00+00:00"
                }
              }
            }
          }
        }
      ],
      "service_to_contract": {
        "$int_key_mapping": {
          "1164": 1
        }
      },
      "shifts_config": {
        "$ShiftsConfig": {
          "ignore_on_order_time": false,
          "ignore_order_income": false,
          "shift_processing_delay": {
            "$timedelta": {
              "hours": 4
            }
          },
          "should_schedule_shift_ended": {
            "$true_or_reason": {
              "reason": null,
              "value": true
            }
          }
        }
      },
      "single_ride_af_decisions_end": {
        "$time": "04:00"
      },
      "subvention_commission_agreement": {
        "$Agreement": {
          "branding_discounts": [
            {
              "$BrandingDiscount": {
                "marketing_level": {
                  "$frozenset": [
                    "lightbox",
                    "co_branding"
                  ]
                },
                "value": {
                  "$decimal": "0.04"
                }
              }
            },
            {
              "$BrandingDiscount": {
                "marketing_level": {
                  "$frozenset": [
                    "lightbox"
                  ]
                },
                "value": {
                  "$decimal": "0.02"
                }
              }
            }
          ],
          "cancellation_settings": {
            "$CancellationSettings": {
              "billable_cancel_distance": 300,
              "billable_park_interval": {
                "$CancellationInterval": {
                  "after_order_due": {
                    "$timedelta": {
                      "seconds": 600
                    }
                  },
                  "before_order_due": {
                    "$timedelta": {
                      "seconds": 420
                    }
                  }
                }
              },
              "billable_user_interval": {
                "$CancellationInterval": {
                  "after_order_due": {
                    "$timedelta": {
                      "seconds": 120
                    }
                  },
                  "before_order_due": {
                    "$timedelta": {
                      "seconds": 600
                    }
                  }
                }
              }
            }
          },
          "category": null,
          "cost_info": {
            "$CostInfoBoundaries": {
              "max_cost": {
                "$decimal": "150000000"
              },
              "min_cost": {
                "$decimal": "0.0000"
              }
            }
          },
          "effective_billing_type": "normal",
          "group": "base",
          "id": "fixed_rate_id",
          "kind": "fixed_rate",
          "rate": {
            "$RateFlat": {
              "value": {
                "$decimal": "0.2300"
              }
            }
          },
          "settings": null,
          "support_info": null,
          "unrealized_rate": null,
          "vat_rate": {
            "$decimal": "1.2"
          }
        }
      },
      "use_bulk_af": false
    }
  }
}
