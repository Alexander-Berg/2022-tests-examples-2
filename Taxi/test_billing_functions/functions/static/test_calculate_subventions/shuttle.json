{
  "cities": {
    "Москва": {
      "country_code": "rus",
      "donate_multipliers": {
        "default": "1.2"
      }
    }
  },
  "currency_rates": {
    "RUBUSD": {
      "2021-06-10": "0.1"
    }
  },
  "expected_docs": [
    {
      "data": {
        "agreement": {
          "ref": "subvention/counter/counter",
          "rule_data": {
            "counter": "counter",
            "currency": "RUB",
            "rule_id": "id1",
            "steps": [
              {
                "amount": "100",
                "nrides": 2
              }
            ],
            "type": "goal"
          }
        },
        "contract": {
          "currency": "USD",
          "id": 1,
          "service_id": 137,
          "target": "oebs"
        },
        "driver": {
          "billing_client_id": "100500",
          "clid": "643753730233",
          "driver_license_personal_id": "some_driver_license_personal_id",
          "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
          "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
          "unique_driver_id": "5b05621ee6c22ea2654849f4"
        },
        "pay_per_contract": "yes",
        "payment_meta": {
          "budget_id": "budget",
          "city_id": "Москва",
          "country_code": "rus",
          "is_cargo": false,
          "oebs_mvp_id": "MSKc",
          "payment_ref": "f213c6b839ff7cd69b85410dc9caae3b",
          "service_to_contract": {
            "137": 1
          },
          "subvention_ref": "748c8b07cace429735a26ea7aa08f60f",
          "tariff_class": "shuttle",
          "tariff_zone": "moscow",
          "time_zone": "Europe/Moscow"
        },
        "shift": {
          "duration_in_days": 2,
          "end": "2021-01-02T03:00:00+03:00",
          "start": "2021-01-01T03:00:00+03:00"
        },
        "version": 1
      },
      "event_at": "2021-01-02T00:00:00+00:00",
      "external_event_ref": "counter/1/1/1",
      "external_obj_id": "taxi/shift/unique_driver_id/5b05621ee6c22ea2654849f4",
      "journal_entries": [],
      "kind": "taxi_goal_shift",
      "process_at": "2021-01-02T04:00:00+00:00",
      "service": "billing-functions",
      "status": "new",
      "tags": [
        "taxi/shift_ended/unique_driver_id/5b05621ee6c22ea2654849f4/2021-01-02/do_x_get_y"
      ]
    },
    {
      "data": {
        "agreement": {
          "ref": "subvention/counter/personal_counter",
          "rule_data": {
            "counter": "personal_counter",
            "currency": "RUB",
            "rule_id": "id_",
            "steps": [
              {
                "amount": "100",
                "nrides": 20
              }
            ],
            "type": "goal"
          }
        },
        "contract": {
          "currency": "USD",
          "id": 1,
          "service_id": 137,
          "target": "oebs"
        },
        "driver": {
          "billing_client_id": "100500",
          "clid": "643753730233",
          "driver_license_personal_id": "some_driver_license_personal_id",
          "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
          "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
          "unique_driver_id": "5b05621ee6c22ea2654849f4"
        },
        "pay_per_contract": "yes",
        "payment_meta": {
          "budget_id": "deadbeef",
          "city_id": "Москва",
          "country_code": "rus",
          "is_cargo": false,
          "oebs_mvp_id": "MSKc",
          "payment_ref": "920d56887c3308f24ac74805e4ac66cd",
          "service_to_contract": {
            "137": 1
          },
          "subvention_ref": "8449c30199a82255fc1a1082cf0f1e56",
          "tariff_class": "shuttle",
          "tariff_zone": "moscow",
          "time_zone": "Europe/Moscow"
        },
        "shift": {
          "duration_in_days": 1,
          "end": "2021-01-02T03:00:00+03:00",
          "start": "2021-01-01T03:00:00+03:00"
        },
        "version": 1
      },
      "event_at": "2021-01-02T00:00:00+00:00",
      "external_event_ref": "personal_counter/5/1/1",
      "external_obj_id": "taxi/shift/unique_driver_id/5b05621ee6c22ea2654849f4",
      "journal_entries": [],
      "kind": "taxi_goal_shift",
      "process_at": "2021-01-02T04:00:00+00:00",
      "service": "billing-functions",
      "status": "new",
      "tags": [
        "taxi/shift_ended/unique_driver_id/5b05621ee6c22ea2654849f4/2021-01-02/do_x_get_y"
      ]
    }
  ],
  "expected_open_shift_requests": [],
  "expected_results": {
    "$Subventions": {
      "antifraud_precheck": {
        "$AntifraudPrecheck": {
          "is_goal_allowed": true,
          "is_single_on_top_allowed": true,
          "is_single_ride_allowed": true
        }
      },
      "is_eligible": true,
      "shifts": [
        {
          "$SubventionShift": {
            "data": {
              "$GoalRuleShift": {
                "contract_id": 1,
                "counter": "counter",
                "kind": "goal",
                "num_orders": 2
              }
            },
            "doc_id": 5000
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$GoalRuleShift": {
                "contract_id": 1,
                "counter": "personal_counter",
                "kind": "goal",
                "num_orders": 2
              }
            },
            "doc_id": 5001
          }
        }
      ]
    }
  },
  "expected_stq_calls": [
    {
      "args": [
        5000
      ],
      "eta": "2021-01-02T04:00:00.000000Z",
      "kwargs": {},
      "task_id": "doc_id/5000"
    },
    {
      "args": [
        5001
      ],
      "eta": "2021-01-02T04:00:00.000000Z",
      "kwargs": {},
      "task_id": "doc_id/5001"
    }
  ],
  "query": {
    "$Query": {
      "acquiring_commission_agreement_rate": null,
      "call_center_surcharge_inc_vat": {
        "$decimal": "0"
      },
      "commissions": [],
      "contracts": [
        {
          "$Contract": {
            "currency": "USD",
            "firm_id": null,
            "id": 1,
            "target": "oebs"
          }
        }
      ],
      "doc_ref": 12345,
      "driver": {
        "$Driver": {
          "activity_points": null,
          "available_tariff_classes": [
            "shuttle"
          ],
          "billing_client_id": "100500",
          "clid": "643753730233",
          "driver_license_personal_id": "some_driver_license_personal_id",
          "driver_profile_id": "657dde13c5a14ef3a320c58c58a27b19",
          "hired_at": null,
          "hiring_type": null,
          "park_id": "7f74df331eb04ad78bc2ff25ff88a8f2",
          "profile_payment_type_restrictions": null,
          "tariff_zone": "kursk",
          "unique_driver_id": "5b05621ee6c22ea2654849f4"
        }
      },
      "goal_precheck_enabled": false,
      "multiply_instant_payments_by_counter": false,
      "netting_config": {
        "$netting_config": {}
      },
      "order": {
        "$Order": {
          "accepted_by_driver_at": {
            "$datetime": "2021-06-10T20:00:00+03:00"
          },
          "cancel_distance": null,
          "cancelled_at": null,
          "cancelled_with_captcha": false,
          "city_id": "Москва",
          "closed_without_accept": false,
          "commission_limit_if_promocode": {
            "$decimal": "0"
          },
          "completed_at": {
            "$datetime": "2021-06-10T20:00:00+03:00"
          },
          "cost": {
            "$decimal": "50"
          },
          "cost_for_driver": null,
          "counter_multiplier": 2,
          "country_code": "rus",
          "currency": "RUB",
          "discount": null,
          "driver_with_promocode": false,
          "driver_with_workshift": false,
          "due": {
            "$datetime": "2021-06-10T20:00:00+03:00"
          },
          "id": "<order_id>",
          "ind_bel_nds_rate": null,
          "is_cargo": false,
          "marketing_level": {
            "$frozenset": []
          },
          "need_dispatcher_acceptance": false,
          "oebs_mvp_id": "MSKc",
          "park_corp_vat": null,
          "park_ride_sum": {
            "$decimal": 0
          },
          "payment_type": {
            "$payment_type": "card"
          },
          "rebate_rate": null,
          "source": null,
          "status": "finished",
          "tariff_class": "shuttle",
          "tariff_zone": "moscow",
          "taxi_status": "complete",
          "time_zone": "Europe/Moscow",
          "transporting_distance_meters": 0,
          "transporting_time_seconds": 0
        }
      },
      "rules": [
        {
          "$GoalRule": {
            "budget_id": "budget",
            "counter": "counter",
            "currency": "RUB",
            "id": "id1",
            "is_personal": false,
            "steps": [
              {
                "$GoalRuleStep": {
                  "amount": {
                    "$decimal": "100"
                  },
                  "nrides": 2
                }
              }
            ],
            "window": {
              "$GoalRuleWindow": {
                "end": {
                  "$datetime": "2021-01-02T00:00:00+00:00"
                },
                "number": 1,
                "size": 2,
                "start": {
                  "$datetime": "2021-01-01T00:00:00+00:00"
                }
              }
            }
          }
        },
        {
          "$GoalRule": {
            "budget_id": "deadbeef",
            "counter": "personal_counter",
            "currency": "RUB",
            "id": "id_",
            "is_personal": true,
            "steps": [
              {
                "$GoalRuleStep": {
                  "amount": {
                    "$decimal": "100"
                  },
                  "nrides": 20
                }
              }
            ],
            "window": {
              "$GoalRuleWindow": {
                "end": {
                  "$datetime": "2021-01-02T00:00:00+00:00"
                },
                "number": 5,
                "size": 1,
                "start": {
                  "$datetime": "2021-01-01T00:00:00+00:00"
                }
              }
            }
          }
        }
      ],
      "service_to_contract": {
        "$int_key_mapping": {
          "137": 1
        }
      },
      "shifts_config": {
        "$ShiftsConfig": {
          "ignore_on_order_time": false,
          "ignore_order_income": false,
          "shift_processing_delay": {
            "$timedelta": {
              "hours": 4
            }
          },
          "should_schedule_shift_ended": {
            "$true_or_reason": {
              "reason": null,
              "value": true
            }
          }
        }
      },
      "single_ride_af_decisions_end": {
        "$time": "04:00"
      },
      "subvention_commission_agreement": null,
      "use_bulk_af": true
    }
  }
}
