{
  "expected_docs": [
    {
      "data": {
        "agreement": {
          "ref": "subvention/counter/counter",
          "rule_data": {
            "counter": "counter",
            "currency": "RUB",
            "rule_id": "id1",
            "steps": [
              {
                "amount": "100",
                "nrides": 2
              }
            ],
            "type": "goal"
          }
        },
        "driver": {
          "driver_license_personal_id": "some_license_id",
          "driver_profile_id": "some_driver_profile_id",
          "park_id": "some_park_id",
          "unique_driver_id": "some_unique_driver_id"
        },
        "payment_meta": {
          "payment_ref": "91882bc49f1d1912f02bbfea7737d394",
          "subvention_ref": "91882bc49f1d1912f02bbfea7737d394",
          "time_zone": "Europe/Moscow"
        },
        "shift": {
          "duration_in_days": 2,
          "end": "2021-01-02T03:00:00+03:00",
          "start": "2021-01-01T03:00:00+03:00"
        },
        "version": 1
      },
      "event_at": "2021-01-02T00:00:00+00:00",
      "external_event_ref": "counter/1/1",
      "external_obj_id": "taxi/shift/unique_driver_id/some_unique_driver_id",
      "journal_entries": [],
      "kind": "eats_goal_shift",
      "process_at": "2021-01-02T04:00:00+00:00",
      "service": "billing-functions",
      "status": "new",
      "tags": [
        "taxi/shift_ended/unique_driver_id/some_unique_driver_id/2021-01-02/do_x_get_y"
      ]
    },
    {
      "data": {
        "agreement": {
          "ref": "subvention/counter/counter",
          "rule_data": {
            "counter": "counter",
            "currency": "RUB",
            "rule_id": "id2",
            "steps": [
              {
                "amount": "200",
                "nrides": 1
              }
            ],
            "type": "goal"
          }
        },
        "driver": {
          "driver_license_personal_id": "some_license_id",
          "driver_profile_id": "some_driver_profile_id",
          "park_id": "some_park_id",
          "unique_driver_id": "some_unique_driver_id"
        },
        "payment_meta": {
          "payment_ref": "91882bc49f1d1912f02bbfea7737d394",
          "subvention_ref": "91882bc49f1d1912f02bbfea7737d394",
          "time_zone": "Europe/Moscow"
        },
        "shift": {
          "duration_in_days": 2,
          "end": "2021-01-02T03:00:00+03:00",
          "start": "2021-01-01T03:00:00+03:00"
        },
        "version": 1
      },
      "event_at": "2021-01-02T00:00:00+00:00",
      "external_event_ref": "counter/1/1",
      "external_obj_id": "taxi/shift/unique_driver_id/some_unique_driver_id",
      "journal_entries": [],
      "kind": "eats_goal_shift",
      "process_at": "2021-01-02T04:00:00+00:00",
      "service": "billing-functions",
      "status": "new",
      "tags": [
        "taxi/shift_ended/unique_driver_id/some_unique_driver_id/2021-01-02/do_x_get_y"
      ]
    }
  ],
  "expected_results": {
    "$EatsSubventionShifts": {
      "shifts": [
        {
          "$SubventionShift": {
            "data": {
              "$GoalRuleShift": {
                "counter": "counter",
                "kind": "goal",
                "num_orders": 2
              }
            },
            "doc_id": 5000
          }
        },
        {
          "$SubventionShift": {
            "data": {
              "$GoalRuleShift": {
                "counter": "counter",
                "kind": "goal",
                "num_orders": 2
              }
            },
            "doc_id": 5001
          }
        }
      ]
    }
  },
  "expected_stq_calls": [
    {
      "args": [
        5000
      ],
      "eta": "2021-01-02T04:00:00.000000Z",
      "kwargs": {},
      "task_id": "doc_id/5000"
    },
    {
      "args": [
        5001
      ],
      "eta": "2021-01-02T04:00:00.000000Z",
      "kwargs": {},
      "task_id": "doc_id/5001"
    }
  ],
  "query": {
    "$Query": {
      "driver": {
        "$Driver": {
          "driver_license_personal_id": "some_license_id",
          "driver_profile_id": "some_driver_profile_id",
          "park_id": "some_park_id",
          "unique_driver_id": "some_unique_driver_id"
        }
      },
      "order": {
        "$Order": {
          "counter_multiplier": 2,
          "tariff_class": "eats",
          "time_zone": "Europe/Moscow",
          "zone_name": "moscow"
        }
      },
      "rules": [
        {
          "$GoalRule": {
            "budget_id": "budget",
            "counter": "counter",
            "currency": "RUB",
            "id": "id1",
            "is_personal": false,
            "steps": [
              {
                "$GoalRuleStep": {
                  "amount": {
                    "$decimal": "100"
                  },
                  "nrides": 2
                }
              }
            ],
            "window": {
              "$GoalRuleWindow": {
                "end": {
                  "$datetime": "2021-01-02T00:00:00+00:00"
                },
                "number": 1,
                "size": 2,
                "start": {
                  "$datetime": "2021-01-01T00:00:00+00:00"
                }
              }
            }
          }
        },
        {
          "$GoalRule": {
            "budget_id": "budget",
            "counter": "counter",
            "currency": "RUB",
            "id": "id2",
            "is_personal": false,
            "steps": [
              {
                "$GoalRuleStep": {
                  "amount": {
                    "$decimal": "200"
                  },
                  "nrides": 1
                }
              }
            ],
            "window": {
              "$GoalRuleWindow": {
                "end": {
                  "$datetime": "2021-01-02T00:00:00+00:00"
                },
                "number": 1,
                "size": 2,
                "start": {
                  "$datetime": "2021-01-01T00:00:00+00:00"
                }
              }
            }
          }
        }
      ],
      "shifts_config": {
        "$ShiftsConfig": {
          "shift_processing_delay": {
            "$timedelta": {
              "hours": 4
            }
          }
        }
      }
    }
  }
}
