{
  "docs": [
    {
      "created": "2021-05-12T06:30:03.098080+00:00",
      "data": {
        "performer": {
          "db_id": "7f7400",
          "driver_uuid": "1086f4"
        },
        "workshift_info": {
          "counter": "100500_5d9cb51a8148494f9971509dd8ea8b88:3",
          "currency": "KZT",
          "hiring_price": "0.095",
          "hiring_price_without_vat": "0.081",
          "park_currency": "USD",
          "park_price": "0.81",
          "park_price_without_vat": "0.69",
          "price": "300",
          "price_without_vat": "254.23",
          "transaction_id": "a343377985d04c7c83739bb0"
        }
      },
      "doc_id": 1002,
      "event_at": "2021-05-12T09:06:14.000000+00:00",
      "external_event_ref": "workshift_bought/100500_5d9cb51a8148494f9971509dd8ea8b88:3",
      "external_obj_id": "taxi/workshift/100500_5d9cb51a8148494f9971509dd8ea8b88:3",
      "kind": "workshift_bought",
      "process_at": "2021-05-12T06:30:03.102042+00:00",
      "revision": 1234568,
      "service": "billing-orders",
      "status": "new"
    }
  ],
  "dwm_response": {
    "/v1/park-commission-rules/match": {
      "json": {
        "rules": [
          {
            "amount_fixed": "0.0000",
            "amount_rate": "0.1333",
            "is_commission_if_platform_commission_is_null_enabled": true,
            "is_platfrom_commission_enabled": true,
            "kind": "order",
            "rule_type_id": "4964b852670045b196e526d59915b777",
            "work_rule_id": "e26a3cf21acfe01198d50030487e046b"
          },
          {
            "amount_rate": "0.0000",
            "kind": "driver_fix",
            "work_rule_id": "e26a3cf21acfe01198d50030487e046b"
          },
          {
            "amount_rate": "0.0265",
            "kind": "subvention",
            "work_rule_id": "e26a3cf21acfe01198d50030487e046b"
          },
          {
            "amount_rate": "0.0321",
            "kind": "workshift"
          }
        ]
      }
    }
  },
  "expected_accounts": [
    {
      "account_id": 1,
      "agreement_id": "taxi/yandex_ride",
      "currency": "KZT",
      "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "workshift/cost"
    },
    {
      "account_id": 2,
      "agreement_id": "taxi/yandex_ride",
      "currency": "KZT",
      "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "workshift/cost/vat"
    },
    {
      "account_id": 3,
      "agreement_id": "taxi/yandex_ride",
      "currency": "KZT",
      "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "commission/workshift/park"
    },
    {
      "account_id": 4,
      "agreement_id": "taxi/yandex_ride",
      "currency": "KZT",
      "entity_external_id": "taximeter_park_id/7f7400",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "workshift/cost"
    },
    {
      "account_id": 5,
      "agreement_id": "taxi/yandex_ride",
      "currency": "KZT",
      "entity_external_id": "taximeter_park_id/7f7400",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "workshift/cost/vat"
    },
    {
      "account_id": 6,
      "agreement_id": "taxi/yandex_ride",
      "currency": "KZT",
      "entity_external_id": "taximeter_park_id/7f7400",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "commission/workshift/park"
    },
    {
      "account_id": 7,
      "agreement_id": "taxi/driver_balance",
      "currency": "KZT",
      "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "total"
    },
    {
      "account_id": 8,
      "agreement_id": "taxi/yandex_ride+0",
      "currency": "KZT",
      "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "workshift/cost"
    },
    {
      "account_id": 9,
      "agreement_id": "taxi/yandex_ride+0",
      "currency": "KZT",
      "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
      "expired": "9999-12-31T23:59:59.999999+00:00",
      "opened": "2018-10-10T09:56:13.758202Z",
      "sub_account": "workshift/cost/vat"
    }
  ],
  "expected_docs": [
    {
      "data": {
        "based_on_doc_id": 1002,
        "counter": "100500_5d9cb51a8148494f9971509dd8ea8b88:3",
        "driver": {
          "db_id": "7f7400",
          "driver_uuid": "1086f4"
        },
        "transaction_id": "a343377985d04c7c83739bb0"
      },
      "event_at": "2021-05-12T09:06:14.000000+00:00",
      "external_event_ref": "taxi/journal/workshift/100500_5d9cb51a8148494f9971509dd8ea8b88:3",
      "external_obj_id": "taxi/workshift/100500_5d9cb51a8148494f9971509dd8ea8b88:3",
      "journal_entries": [
        {
          "account_id": 1,
          "amount": "-254.23",
          "details": {},
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 2,
          "amount": "-45.77",
          "details": {},
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 3,
          "amount": "-9.6300",
          "details": {},
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 4,
          "amount": "-254.23",
          "details": {
            "driver": {
              "driver_uuid": "1086f4"
            }
          },
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 5,
          "amount": "-45.77",
          "details": {
            "driver": {
              "driver_uuid": "1086f4"
            }
          },
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 6,
          "amount": "-9.6300",
          "details": {
            "driver": {
              "driver_uuid": "1086f4"
            }
          },
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 7,
          "amount": "-309.6300",
          "details": null,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 8,
          "amount": "-254.23",
          "details": {},
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account_id": 9,
          "amount": "-45.77",
          "details": {},
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        }
      ],
      "kind": "journal",
      "service": "billing-calculators",
      "status": "new"
    },
    {
      "data": {
        "based_on_doc_id": 1002,
        "billing_park_commission_flow": true,
        "driver": {
          "db_id": "7f7400",
          "driver_uuid": "1086f4"
        },
        "kind": "workshift",
        "payments": [
          {
            "agreement": "taxi/yandex_ride",
            "amount": "-300.00",
            "currency": "KZT",
            "sub_account": "workshift/cost_with_vat"
          }
        ],
        "transaction_id": "a343377985d04c7c83739bb0"
      },
      "event_at": "2021-05-12T09:06:14.000000+00:00",
      "external_event_ref": "taxi/taximeter_request/workshift/a343377985d04c7c83739bb0",
      "external_obj_id": "taxi/taximeter_request/workshift/a343377985d04c7c83739bb0",
      "journal_entries": [],
      "kind": "taximeter_request",
      "service": "billing-calculators",
      "status": "new"
    }
  ],
  "expected_docs_updated_events": [
    {
      "data": {
        "park_commission_rule": {
          "amount_rate": "0.0321",
          "kind": "workshift"
        }
      },
      "doc_id": 1002,
      "entry_ids": [],
      "idempotency_key": "park_commission_rule",
      "revision": 1234568,
      "status": "new"
    }
  ],
  "expected_entities": [
    {
      "external_id": "taximeter_driver_id/7f7400/1086f4",
      "kind": "driver"
    },
    {
      "external_id": "taximeter_park_id/7f7400",
      "kind": "park"
    }
  ],
  "expected_stq_balance_update_calls": [
    {
      "args": null,
      "eta": null,
      "kwargs": {
        "account": {
          "agreement_id": "taxi/driver_balance",
          "currency": "KZT",
          "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
          "sub_account": "total"
        },
        "log_extra": {},
        "max_entry_id": 1755330117
      },
      "queue": "billing_functions_internal_balance_update",
      "task_id": "doc_id/2001/1755330117"
    }
  ],
  "reports": {
    "journal/search": {
      "entries": [
        {
          "account": {
            "account_id": 1,
            "agreement_id": "taxi/yandex_ride",
            "currency": "KZT",
            "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
            "sub_account": "workshift/cost"
          },
          "amount": "-254.23",
          "details": {},
          "doc_ref": "2001",
          "entry_id": 1755330111,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 2,
            "agreement_id": "taxi/yandex_ride",
            "currency": "KZT",
            "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
            "sub_account": "workshift/cost/vat"
          },
          "amount": "-45.77",
          "details": {},
          "doc_ref": "2001",
          "entry_id": 1755330112,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 3,
            "agreement_id": "taxi/yandex_ride",
            "currency": "KZT",
            "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
            "sub_account": "commission/workshift/park"
          },
          "amount": "-9.6300",
          "details": {},
          "doc_ref": "2001",
          "entry_id": 1755330113,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 4,
            "agreement_id": "taxi/yandex_ride",
            "currency": "KZT",
            "entity_external_id": "taximeter_park_id/7f7400",
            "sub_account": "workshift/cost"
          },
          "amount": "-254.23",
          "details": {
            "driver": {
              "driver_uuid": "1086f4"
            }
          },
          "doc_ref": "2001",
          "entry_id": 1755330114,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 5,
            "agreement_id": "taxi/yandex_ride",
            "currency": "KZT",
            "entity_external_id": "taximeter_park_id/7f7400",
            "sub_account": "workshift/cost/vat"
          },
          "amount": "-45.77",
          "details": {
            "driver": {
              "driver_uuid": "1086f4"
            }
          },
          "doc_ref": "2001",
          "entry_id": 1755330115,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 6,
            "agreement_id": "taxi/yandex_ride",
            "currency": "KZT",
            "entity_external_id": "taximeter_park_id/7f7400",
            "sub_account": "commission/workshift/park"
          },
          "amount": "-9.6300",
          "details": {
            "driver": {
              "driver_uuid": "1086f4"
            }
          },
          "doc_ref": "2001",
          "entry_id": 1755330116,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 7,
            "agreement_id": "taxi/driver_balance",
            "currency": "KZT",
            "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
            "sub_account": "total"
          },
          "amount": "-309.6300",
          "details": null,
          "doc_ref": "2001",
          "entry_id": 1755330117,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 8,
            "agreement_id": "taxi/yandex_ride+0",
            "currency": "KZT",
            "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
            "sub_account": "workshift/cost"
          },
          "amount": "-254.23",
          "details": {},
          "doc_ref": "2001",
          "entry_id": 1755330118,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        },
        {
          "account": {
            "account_id": 9,
            "agreement_id": "taxi/yandex_ride+0",
            "currency": "KZT",
            "entity_external_id": "taximeter_driver_id/7f7400/1086f4",
            "sub_account": "workshift/cost/vat"
          },
          "amount": "-45.77",
          "details": {},
          "doc_ref": "2001",
          "entry_id": 1755330119,
          "event_at": "2021-05-12T09:06:14.000000+00:00",
          "reason": ""
        }
      ]
    }
  }
}
