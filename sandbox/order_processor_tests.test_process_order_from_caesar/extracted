Selects from CaeSaR
<{Info for Order 172056991
%%{
    "OrderID": 172056991, 
    "Flags": {
        "LastActiveTime": 1649058224, 
        "Stop": false, 
        "Version": 1226467634, 
        "OrderFirstActiveTime": 1647252133, 
        "Archive": false, 
        "IsActive": true
    }, 
    "Resources": {
        "DirectBannersLogFields": {
            "OrderType": 1, 
            "GroupOrderID": 165919339, 
            "ContentType": "text", 
            "DirectOrderID": 72056991
        }, 
        "ShowConditions": {
            "TargetTypes": [
                3
            ], 
            "StopTime": 0, 
            "TimeZone": "Europe/Moscow"
        }
    }, 
    "ShowConditions": {
        "ContextID": 8756266989624091372
    }
}%%
https://lookup-profile-caesar1.n.yandex-team.ru/lookup_profile/Orders/?OrderID=172056991
}>
<{Trimmed info for all 2 banners
<{Info for Banner 72057605887880719
%%{
    "OrderID": 172056991, 
    "BannerID": 72057605887880720, 
    "Flags": {
        "LastActiveTimestamp": 1649055407, 
        "GenocideRateV2": 0.75801, 
        "Stop": false, 
        "GenocideRate": 11, 
        "EngineID": 7, 
        "Source": 1, 
        "Version": 1226467634, 
        "OrderUpdateTime": 1648137217, 
        "LastOrderArchiveCheckedTimestamp": 1649055407, 
        "FirstSeenInCaesarTimestamp": 1647250590, 
        "FirstActiveTimestamp": 1647250620, 
        "Archive": false
    }, 
    "ModerationData": {
        "MarkupFlags": [
            1
        ], 
        "TimestampMilliseconds": 1648878309000
    }, 
    "Resources": {
        "Body": "Работаем 24/7. Автомобили любого класса, опытные водители. Поездки по городу/загород.", 
        "Title": "taxi-Nnov – Заказ такси по телефону в Нижнем Новгороде", 
        "Site": "taxi-nnov.ru", 
        "HrefText": "", 
        "Href": "https://taxi-nnov.ru", 
        "TargetDomain": "taxi-nnov.ru", 
        "GroupBannerID": 4849535312
    }
}%%
https://lookup-profile-caesar1.n.yandex-team.ru/lookup_profile/Banners/?BannerID=72057605887880719
}>

<{Info for Banner 72057605887880720
%%{
    "OrderID": 172056991, 
    "BannerID": 72057605887880720, 
    "Flags": {
        "LastActiveTimestamp": 1649055407, 
        "GenocideRateV2": 0.75801, 
        "Stop": false, 
        "GenocideRate": 11, 
        "EngineID": 7, 
        "Source": 1, 
        "Version": 1226467634, 
        "OrderUpdateTime": 1648137217, 
        "LastOrderArchiveCheckedTimestamp": 1649055407, 
        "FirstSeenInCaesarTimestamp": 1647250590, 
        "FirstActiveTimestamp": 1647250620, 
        "Archive": false
    }, 
    "ModerationData": {
        "MarkupFlags": [
            1
        ], 
        "TimestampMilliseconds": 1648878309000
    }, 
    "Resources": {
        "Body": "Работаем 24/7. Автомобили любого класса, опытные водители. Поездки по городу/загород.", 
        "Title": "taxi-Nnov – Заказ такси по телефону в Нижнем Новгороде", 
        "Site": "taxi-nnov.ru", 
        "HrefText": "", 
        "Href": "https://taxi-nnov.ru", 
        "TargetDomain": "taxi-nnov.ru", 
        "GroupBannerID": 4849535312
    }
}%%
https://lookup-profile-caesar1.n.yandex-team.ru/lookup_profile/Banners/?BannerID=72057605887880720
}>
}>
<{Info for AdGroup 4849535312
%%{
    "OrderID": 172056991, 
    "AdGroupID": 4849535312, 
    "ShowConditions": {
        "ContextID": 5043088087932831465
    }
}%%
https://lookup-profile-caesar1.n.yandex-team.ru/lookup_profile/AdGroups/?AdGroupID=4849535312
}>
<{Phrases from AdGroups
%%+------------+----------------------+-------------+------+----------+------------+------------+-----------+
| AdGroupID  | PhraseID             | ContextType | Cost | FlatCost | UpdateTime | DeleteTime | Suspended |
+------------+----------------------+-------------+------+----------+------------+------------+-----------+
| 4849535312 | 14142439             | 1           | 0    | 0        | 1648825846 | 0          | False     |
| 4849535312 | 3407343730484110725  | 1           | 0    | 0        | 1648717846 | 0          | False     |
| 4849535312 | 18253525167574770728 | 1           | 0    | 0        | 1648717846 | 0          | False     |
| 4849535312 | 601582293            | 1           | 0    | 0        | 1648984649 | 0          | False     |
| 4849535312 | 17133726246108070075 | 1           | 0    | 0        | 1648606992 | 0          | False     |
| 4849535312 | 16299453332286734812 | 1           | 0    | 0        | 1648717846 | 0          | False     |
+------------+----------------------+-------------+------+----------+------------+------------+-----------+%%}>
<{Patterns from ShowConditions in Order and  AdGroups
%%+---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ContextID           | Expression                                                                                                                                                                                                                                                        |
+---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 8756266989624091372 | {                                                                                                                                                                                                                                                                 |
|                     |     "and": [                                                                                                                                                                                                                                                      |
|                     |         {                                                                                                                                                                                                                                                         |
|                     |             "or": [                                                                                                                                                                                                                                               |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "Region (77)",                                                                                                                                                                                                                     |
|                     |                     "operation": "not equal (5)",                                                                                                                                                                                                                 |
|                     |                     "value": "3"                                                                                                                                                                                                                                  |
|                     |                 }                                                                                                                                                                                                                                                 |
|                     |             ]                                                                                                                                                                                                                                                     |
|                     |         },                                                                                                                                                                                                                                                        |
|                     |         {                                                                                                                                                                                                                                                         |
|                     |             "or": [                                                                                                                                                                                                                                               |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "ÐÐ°ÐºÐ¾Ð¹ ÑÐ¾ Ð²Ð°ÑÐ¸Ð°Ð½Ñ (236)",                                                |
|                     |                     "operation": "time not like (18)",                                                                                                                                                                                                            |
|                     |                     "value": "12345ABCDEFGHIJTUVWX"                                                                                                                                                                                                               |
|                     |                 },                                                                                                                                                                                                                                                |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "ÐÐ°ÐºÐ¾Ð¹ ÑÐ¾ Ð²Ð°ÑÐ¸Ð°Ð½Ñ (236)",                                                |
|                     |                     "operation": "time not like (18)",                                                                                                                                                                                                            |
|                     |                     "value": "67ABCDEFGWX"                                                                                                                                                                                                                        |
|                     |                 }                                                                                                                                                                                                                                                 |
|                     |             ]                                                                                                                                                                                                                                                     |
|                     |         }                                                                                                                                                                                                                                                         |
|                     |     ]                                                                                                                                                                                                                                                             |
|                     | }                                                                                                                                                                                                                                                                 |
| 5043088087932831465 | {                                                                                                                                                                                                                                                                 |
|                     |     "and": [                                                                                                                                                                                                                                                      |
|                     |         {                                                                                                                                                                                                                                                         |
|                     |             "or": [                                                                                                                                                                                                                                               |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "ÐÐ°ÐºÐ¾Ð¹ ÑÐ¾ Ð²Ð°ÑÐ¸Ð°Ð½Ñ (236)",                                                |
|                     |                     "operation": "regexp (3)",                                                                                                                                                                                                                    |
|                     |                     "value": "542"                                                                                                                                                                                                                                |
|                     |                 }                                                                                                                                                                                                                                                 |
|                     |             ]                                                                                                                                                                                                                                                     |
|                     |         },                                                                                                                                                                                                                                                        |
|                     |         {                                                                                                                                                                                                                                                         |
|                     |             "or": [                                                                                                                                                                                                                                               |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "Ð¢ÐµÑÑÐ¸ÑÑÐµÐ¼ ÐºÐ¾Ð´Ð¸ÑÐ¾Ð²ÐºÑ (17)",  |
|                     |                     "operation": "equal (4)",                                                                                                                                                                                                                     |
|                     |                     "value": "20044"                                                                                                                                                                                                                              |
|                     |                 },                                                                                                                                                                                                                                                |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "Imp (1)",                                                                                                                                                                                                                         |
|                     |                     "operation": "equal (4)",                                                                                                                                                                                                                     |
|                     |                     "value": "47"                                                                                                                                                                                                                                 |
|                     |                 },                                                                                                                                                                                                                                                |
|                     |                 {                                                                                                                                                                                                                                                 |
|                     |                     "keyword": "Ð¢ÐµÑÑÐ¸ÑÑÐµÐ¼ ÐºÐ¾Ð´Ð¸ÑÐ¾Ð²ÐºÑ (17)",  |
|                     |                     "operation": "like (2)",                                                                                                                                                                                                                      |
|                     |                     "value": "972"                                                                                                                                                                                                                                |
|                     |                 }                                                                                                                                                                                                                                                 |
|                     |             ]                                                                                                                                                                                                                                                     |
|                     |         }                                                                                                                                                                                                                                                         |
|                     |     ]                                                                                                                                                                                                                                                             |
|                     | }                                                                                                                                                                                                                                                                 |
+---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+%%}>
<{The following queries may also be useful
<{bs-filter-log [legacy]
%%
pragma yt.DataSizePerJob='500000000';
PRAGMA yt.PoolTrees = "physical";
PRAGMA yt.TentativePoolTrees = "cloud";

SELECT
    reason,
    description,
    COUNT(*)
FROM
    hahn.[home/logfeller/logs/bs-filter-log/1d/<DATE>]
where orderid = <OREDERID>
group by
    reason,
    description
%%
}>
<{bs-match-log
%%
SELECT
    stage,
    COUNT(*)
FROM hahn.[home/logfeller/logs/bs-match-log/1d/<DATE>]
where orderid = "ORDERID" and entrytype = "MATCH"
group by stage;
%%
}>
<{bs-match-log (with Filter Reasons)
%%
PRAGMA File('yabs.so', 'https://proxy.sandbox.yandex-team.ru/last/YABS_UDF/libyabs_udf.so');
PRAGMA udf('yabs.so');

SELECT
    reasonid,
    stage,
    object,
    some(reason) as reason,
    some(Yabs::StrFilterReasonDescription(reasonid)) as description,
    COUNT(distinct hitlogid) as affected_hits,
    COUNT(*) as cnt
FROM
    hahn.`home/logfeller/logs/bs-match-log/1d/<DATE>`
where orderid = '<ORDERID>'
group by
    reasonid, stage, object
order by affected_hits desc;
%%
}>
}>