<test>
    <variables>
        <path>
            <instance id="blackbox">blackbox</instance>
        </path>

        <cgi name="method">
            <instance id="sessionid">sessionid</instance>
            <instance id="oauth">oauth</instance>
            <instance id="login">login</instance>
            <instance id="userinfo">userinfo</instance>
            <instance id="user_ticket">user_ticket</instance>
            <instance id="checkip">checkip</instance>
            <instance id="pwdhistory">pwdhistory</instance>
            <instance id="createsession">createsession</instance>
            <instance id="editsession">editsession</instance>
            <instance id="loginoccupation">loginoccupation</instance>
            <instance id="hosted_domains">hosted_domains</instance>
            <instance id="find_pdd_accounts">find_pdd_accounts</instance>
            <instance id="phone_bindings">phone_bindings</instance>
            <instance id="phone_operations">phone_operations</instance>
            <instance id="test_pwd_hashes">test_pwd_hashes</instance>
            <instance id="get_track">get_track</instance>
            <instance id="email_bindings">email_bindings</instance>
            <instance id="get_all_tracks">get_all_tracks</instance>
            <instance id="yakey_backup">yakey_backup</instance>
        </cgi>

        <cgi name="userip">
            <instance id="localhost">127.0.0.1</instance>
        </cgi>

        <cgi name="oauth_token">
            <instance id="valid_forever">Ae54HegAAAilDTHUkEKQR7K-ds921u1lkA</instance>
        </cgi>

        <cgi name="host">
            <instance id="ru">yandex.ru</instance>
        </cgi>

        <cgi name="uid">
            <instance id="70495">70495</instance>
        </cgi>

        <cgi name="partition">
            <instance id="default">default</instance>
            <instance id="foo">foo</instance>
            <instance id="bar">bar</instance>
            <instance id="all">default,foo,bar</instance>
        </cgi>

        <cgi name="attributes">
            <instance id="everyone">98</instance>
            <instance id="bb_test_1_has">1010</instance>
            <instance id="bb_test_1_no">101</instance>
            <instance id="bb_test_2_has">1012</instance>
            <instance id="bb_test_2_no">104</instance>

            <instance id="bb_test_5_no1">101</instance>
            <instance id="bb_test_5_no2">1010</instance>
            <instance id="bb_test_5_has1">1012</instance>
            <instance id="bb_test_5_has2">104</instance>
        </cgi>

        <cgi name="getphones">
            <instance id="all">all</instance>
        </cgi>

        <cgi name="phone_attributes">
            <instance id="1">1</instance>
        </cgi>

        <cgi name="login">
            <instance id="malice">malice</instance>
        </cgi>

        <cgi name="logins">
            <instance id="malice">malice</instance>
        </cgi>

        <cgi name="password">
            <instance id="valid">qwerty</instance>
        </cgi>

        <cgi name="captcha">
            <instance id="no">no</instance>
        </cgi>

        <cgi name="dbfields">
            <instance id="everyone">userphones.number.uid</instance>
            <instance id="bb_test_1_has">accounts.ena.uid</instance>
            <instance id="bb_test_1_no">accounts.glogout.uid</instance>
            <instance id="bb_test_2_has">userinfo.display_name.uid</instance>
            <instance id="bb_test_2_no">accounts.karma.uid</instance>

            <instance id="bb_test_5_no1">accounts.karma.uid</instance>
            <instance id="bb_test_5_no2">userphones.number.uid</instance>
            <instance id="bb_test_5_has1">accounts.ena.uid</instance>
            <instance id="bb_test_5_has2">accounts.glogout.uid</instance>
        </cgi>

        <cgi name="sessionid" func="gensessid">
            <instance id="ru_70495">
                <arg name="uid">70495</arg>
                <arg name="host">yandex.ru</arg>
                <arg name="type">valid</arg>
                <arg name="time">-10</arg>
            </instance>
        </cgi>

        <cgi name="keyspace">
            <instance id="ru">yandex.ru</instance>
        </cgi>

        <cgi name="nets">
            <instance id="yandexusers">yandexusers</instance>
        </cgi>

        <cgi name="ip">
            <instance id="internal_user">95.108.132.35</instance>
        </cgi>

        <cgi name="depth">
            <instance id="three">3</instance>
        </cgi>

        <cgi name="reason">
            <instance id="one">1,1,1,1,,1</instance>
        </cgi>

        <cgi name="op">
            <instance id="select">select</instance>
        </cgi>

        <cgi name="domain_id">
            <instance id="imap">2</instance>
        </cgi>

        <cgi name="type">
            <instance id="current">current</instance>
        </cgi>

        <cgi name="phone_ids">
            <instance id="three">3,2,7</instance>
        </cgi>

        <cgi name="finished_before">
            <instance id="with_data">2065707484</instance>
        </cgi>

        <cgi name="hashes">
            <instance id="qwerty1">MTokMSQySWdPL2dodyRVeWpacllmeHl4dmdXMDlEMnp6Qncu</instance>
        </cgi>

        <cgi name="track_id">
            <instance id="normal">13093f924f16b855c8d1f8e418e41138</instance>
        </cgi>

        <cgi name="email">
            <instance id="cerevra_yt">cerevra@yandex-team.ru</instance>
        </cgi>

        <cgi name="phone_number">
            <instance id="1">79161111111</instance>
        </cgi>

        <cgi name="user_ticket" func="gen_user_ticket">
            <instance id="70495">
                <arg name="default_uid">70495</arg>
            </instance>
        </cgi>

        <header name="X-Ya-Service-Ticket" func="get_service_ticket">
            <instance id="passport_dev">
                <arg name="dst">242</arg>
            </instance>
            <instance id="bb_test_1">
                <arg name="dst">251</arg>
            </instance>
            <instance id="bb_test_2">
                <arg name="dst">252</arg>
            </instance>
            <instance id="bb_test_5">
                <arg name="dst">254</arg>
            </instance>
            <instance id="id_ip_denied">
                <arg name="dst">253</arg>
            </instance>
            <instance id="not_exists_grants">
                <arg name="dst">257</arg>
            </instance>
            <instance id="invalid">
                <arg name="const_value">some invalid ticket</arg>
            </instance>
        </header>

        <result name="id_client_not_configured">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex">BlackBox error: Access denied: tvm_id=[0-9]+ is not allowed</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>

        <result name="id_invalid_ticket">
            <body func="matchxpath">
                <arg name="/doc/exception">UNKNOWN</arg>
                <arg name="/doc/exception/@id">1</arg>
                <arg name="/doc/error" comp="starts_with">BlackBox error: failed to check service ticket: Malformed ticket. status=malformed;: 'some invalid ticket'. request_id=</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>

        <result name="id_ip_denied">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex">BlackBox error: Access denied: IP=[0-9a-z\.\:]+ is not allowed for tvm_id=[0-9]+</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>

        <result name="id_ok">
            <body func="matchxpath">
                <arg name="/doc/exception">dontmatch</arg>
            </body>
        </result>

        <result name="id_partition_denied">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex">BlackBox error: Access denied: no grants for partition 'bar'. consumer: [0-9a-z_]+ \(tvm_id=\d+;IP=[0-9a-z\.\:]+\)</arg>
             </body>
        </result>

        <result name="id_partition_not_supported">
            <body func="matchxpath">
                <arg name="/doc/exception">INVALID_PARAMS</arg>
                <arg name="/doc/exception/@id">2</arg>
                <arg name="/doc/error" comp="starts_with" substitute="1">BlackBox error: Partitions are not supported for method=\~`cgi:method`</arg>
            </body>
        </result>

        <result name="id_dbfield_denied">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex" substitute="1">BlackBox error: Access denied: no grants for dbfield '\~`cgi:dbfields`'. consumer: [0-9a-z_]+ \(tvm_id=\d+;IP=[0-9a-z\.\:]+\)</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>
        <result name="id_attr_denied">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex" substitute="1">BlackBox error: Access denied: no grants for attribute '\~`cgi:attributes`'. consumer: [0-9a-z_]+ \(tvm_id=\d+;IP=[0-9a-z\.\:]+\)</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>
        <result name="id_phone_attr_denied">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex" substitute="1">BlackBox error: Access denied: no grants for phone attribute '\~`cgi:phone_attributes`'. consumer: [0-9a-z_]+ \(tvm_id=\d+;IP=[0-9a-z\.\:]+\)</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>
        <result name="id_method_denied">
            <body func="matchxpath">
                <arg name="/doc/exception">ACCESS_DENIED</arg>
                <arg name="/doc/exception/@id">21</arg>
                <arg name="/doc/error" comp="regex">BlackBox error\: Access denied\: no grants for (method=)?[a-zA-Z_]+\. consumer: [0-9a-z_]+ \(tvm_id=\d+;IP=[0-9a-z\.\:]+\)</arg>
                <arg name="/doc/ttl">dontmatch</arg>
                <arg name="/doc/uid">dontmatch</arg>
            </body>
        </result>

    </variables>

    <node>
        <description>BlackBox</description>

        <case lastid="general">
            <description>General checks for args and ips</description>
            <path>blackbox</path>
            <cgi name="method">login</cgi>
            <cgi name="userip">*</cgi>
            <cgi name="login">*</cgi>
            <cgi name="password">*</cgi>
            <cgi name="captcha">no</cgi>
            <header name="X-Ya-Service-Ticket">bb_test_1;id_ip_denied;not_exists_grants;invalid</header>

            <check>
                <header name="X-Ya-Service-Ticket">bb_test_1</header>
                <result>id_ok</result>
            </check>
            <check>
                <header name="X-Ya-Service-Ticket">id_ip_denied</header>
                <result>id_ip_denied</result>
            </check>
            <check>
                <header name="X-Ya-Service-Ticket">not_exists_grants</header>
                <result>id_client_not_configured</result>
            </check>
            <check>
                <header name="X-Ya-Service-Ticket">invalid</header>
                <result>id_invalid_ticket</result>
            </check>
        </case>

        <case lastid="attr">
            <description>Check attributes</description>
            <path>blackbox</path>
            <cgi name="method">login;userinfo;sessionid;oauth</cgi>
            <cgi name="userip">*</cgi>
            <cgi name="login">*</cgi>
            <cgi name="password">*</cgi>
            <cgi name="dbfields" withnull="1">everyone;bb_test_1_has;bb_test_1_no;bb_test_2_has;bb_test_2_no</cgi>
            <cgi name="attributes" withnull="1">everyone;bb_test_1_has;bb_test_1_no;bb_test_2_has;bb_test_2_no</cgi>
            <cgi name="phone_attributes" withnull="1">*</cgi>
            <cgi name="captcha">no</cgi>
            <cgi name="sessionid">*</cgi>
            <cgi name="host">*</cgi>
            <cgi name="oauth_token">*</cgi>
            <cgi name="getphones">*</cgi>
            <header name="X-Ya-Service-Ticket">bb_test_1;bb_test_2</header>

            <!-- Check 'bb_test_1' -->
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="dbfields">bb_test_1_has</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_1</header>
                <result>id_dbfield_denied</result>
            </check>
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="attributes">bb_test_1_has</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_1</header>
                <result>id_attr_denied</result>
            </check>
            <check>
                <header name="X-Ya-Service-Ticket">bb_test_1</header>
                <result>id_ok</result>
            </check>

            <!-- Check 'bb_test_2' -->
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="dbfields">bb_test_2_has</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_2</header>
                <result>id_dbfield_denied</result>
            </check>
            <check>
                <cgi name="dbfields">bb_test_1_has;bb_test_1_no</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_2</header>
                <result>id_dbfield_denied</result>
            </check>
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="attributes">bb_test_2_has</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_2</header>
                <result>id_attr_denied</result>
            </check>
            <check>
                <cgi name="attributes">bb_test_1_has;bb_test_1_no</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_2</header>
                <result>id_attr_denied</result>
            </check>
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="phone_attributes">1</cgi>
                <header name="X-Ya-Service-Ticket">bb_test_2</header>
                <result>id_phone_attr_denied</result>
            </check>
            <check>
                <header name="X-Ya-Service-Ticket">bb_test_2</header>
                <result>id_ok</result>
            </check>
        </case>

        <case lastid="intersect">
            <description>Check intersection of no_cred and has_cred sections</description>
            <path>blackbox</path>
            <cgi name="method">login;userinfo</cgi>
            <cgi name="userip">*</cgi>
            <cgi name="login">*</cgi>
            <cgi name="password">*</cgi>
            <cgi name="dbfields">bb_test_5_has1;bb_test_5_has2;bb_test_5_no1;bb_test_5_no2</cgi>
            <cgi name="attributes">bb_test_5_has1;bb_test_5_has2;bb_test_5_no1;bb_test_5_no2</cgi>
            <cgi name="phone_attributes" withnull="1">*</cgi>
            <cgi name="captcha">no</cgi>
            <cgi name="getphones">*</cgi>
            <header name="X-Ya-Service-Ticket">bb_test_5</header>

            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="dbfields">bb_test_5_has1;bb_test_5_has2</cgi>
                <result>id_dbfield_denied</result>
            </check>
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="attributes">bb_test_5_has1;bb_test_5_has2</cgi>
                <result>id_attr_denied</result>
            </check>
            <check>
                <cgi name="method">userinfo</cgi>
                <cgi name="phone_attributes">1</cgi>
                <result>id_phone_attr_denied</result>
            </check>

            <check>
                <result>id_ok</result>
            </check>
        </case>


        <case lastid="partition">
            <description>Check grants for partition</description>
            <path>blackbox</path>
            <cgi name="method">login;userinfo;sessionid;oauth;user_ticket</cgi>
            <cgi name="userip">localhost</cgi>
            <cgi name="host">ru</cgi>
            <cgi name="login">malice</cgi>
            <cgi name="password">valid</cgi>
            <cgi name="sessionid">ru_70495</cgi>
            <cgi name="oauth_token">valid_forever</cgi>
            <cgi name="user_ticket">70495</cgi>
            <cgi name="partition" withnull="1">*</cgi>
            <header name="X-Ya-Service-Ticket">passport_dev</header>

            <check>
                <cgi name="partition">bar;all</cgi>
                <result>id_partition_denied</result>
            </check>

            <check>
                <cgi name="partition">foo</cgi>
                <result>id_partition_not_supported</result>
            </check>

            <check>
                <result>id_ok</result>
            </check>
        </case>


        <case lastid="method">
            <description>Check grants for method</description>
            <path>blackbox</path>
            <cgi name="method">login;userinfo;sessionid;oauth</cgi>
            <cgi name="userip">*</cgi>
            <cgi name="login">*</cgi>
            <cgi name="password">*</cgi>
            <cgi name="captcha">no</cgi>
            <cgi name="sessionid">*</cgi>
            <cgi name="host">*</cgi>
            <cgi name="oauth_token">*</cgi>
            <header name="X-Ya-Service-Ticket">bb_test_5</header>

            <check>
                <cgi name="method">sessionid;oauth</cgi>
                <result>id_method_denied</result>
            </check>

            <check>
                <result>id_ok</result>
            </check>
        </case>

        <case>
            <description>Testing many methods</description>
            <path>blackbox</path>
            <cgi name="method">
                checkip;pwdhistory;createsession;editsession;loginoccupation;hosted_domains;
                find_pdd_accounts;phone_bindings;phone_operations;test_pwd_hashes;get_track;email_bindings;get_all_tracks;yakey_backup
            </cgi>
            <cgi name="uid">70495</cgi>
            <cgi name="phone_number">*</cgi>
            <cgi name="email">*</cgi>
            <cgi name="track_id">*</cgi>
            <cgi name="hashes">*</cgi>
            <cgi name="password">*</cgi>
            <cgi name="finished_before">*</cgi>
            <cgi name="type">current</cgi>
            <cgi name="phone_ids">*</cgi>
            <cgi name="domain_id">*</cgi>
            <cgi name="logins">*</cgi>
            <cgi name="userip">*</cgi>
            <cgi name="op">select</cgi>
            <cgi name="host">*</cgi>
            <cgi name="sessionid">*</cgi>
            <cgi name="keyspace">ru</cgi>
            <cgi name="depth">three</cgi>
            <cgi name="reason">one</cgi>
            <cgi name="ip">*</cgi>
            <cgi name="nets">*</cgi>
            <header name="X-Ya-Service-Ticket">bb_test_1;passport_dev</header>

            <check>
                <header name="X-Ya-Service-Ticket">bb_test_1</header>
                <result>id_method_denied</result>
            </check>

            <check>
                <result>id_ok</result>
            </check>
        </case>

    </node>

</test>
